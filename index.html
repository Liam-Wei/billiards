<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#F2F2F7">
    <title>桌球记分</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="toast">已保存</div>

    <header>
        <div class="header-left">
            <button class="icon-btn" onclick="openSettings()">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <button class="icon-btn" onclick="openLogModal()">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
        </div>

        <div class="timer-container">
            <button class="timer-btn" id="timerControlBtn" onclick="toggleTimer()">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <div class="timer-display timer-paused" id="gameTimer">00:00:00</div>
        </div>

        <div class="header-right">
            <button class="reset-btn" onclick="openResetModal()">重置</button>
        </div>
    </header>

    <div class="info-bar">
        <div class="logs-area" id="logsArea">
            <div style="opacity:0.3">等待开局...</div>
        </div>
        <div class="round-area" id="roundBigDisplay">0<small>回合</small></div>
        <div class="leaderboard-area" id="leaderboardArea"></div> 
    </div>

    <main id="container"></main>

    <footer>
        <button class="footer-btn btn-undo" onclick="undo()">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" stroke-linecap="round" stroke-linejoin="round"/></svg>撤销
        </button>
        <button class="footer-btn btn-save" onclick="handleSettleNow(); return false;">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"/></svg>结算/分享
        </button>
    </footer>

    <div class="modal-overlay" id="confirmModal" style="z-index: 150;">
        <div class="center-box">
            <div id="confirmTitle" style="font-size:18px; font-weight:800; margin-bottom:12px;">操作确认</div>
            <div id="confirmDesc" style="font-size:15px; color:#333; margin-bottom:8px; font-weight:600;"></div>
            <div id="confirmDetail" style="font-size:13px; color:#666; margin-bottom:20px; background:#F2F2F7; padding:10px; border-radius:8px;"></div>
            <div style="display:flex; gap:10px;">
                <button style="flex:1; padding:12px; border:none; border-radius:12px; background:#F2F2F7; color:#8E8E93; font-weight:600;" onclick="closeConfirmModal()">取消</button>
                <button id="realConfirmBtn" class="btn-confirm" onclick="confirmPendingAction()" disabled>确定 (0.5s)</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="helpModal" style="z-index: 190;">
        <div class="center-box" style="width:320px;">
            <div id="helpTitle" style="font-size:18px; font-weight:800; margin-bottom:10px;">说明</div>
            <div id="helpBody" style="font-size:13px; color:#333; text-align:left; line-height:1.6; white-space:pre-line; margin-bottom:16px;"></div>
            <button style="width:100%; padding:12px; background:#F2F2F7; color:#333; border:none; border-radius:12px; font-weight:700;" onclick="closeHelpModal()">关闭</button>
        </div>
    </div>

    <div class="modal-overlay" id="resetModal" style="z-index: 160;">
        <div class="center-box">
            <div style="font-size:18px; font-weight:800; margin-bottom:10px;">重置</div>
            <div id="resetDesc" style="font-size:13px; color:#666; margin-bottom:16px; background:#F2F2F7; padding:10px; border-radius:10px;"></div>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button style="width:100%; padding:12px; border:none; border-radius:12px; background:#1C1C1E; color:#FFF; font-weight:700;" onclick="resetCurrentSession()">新开一局（仅当前模式）</button>
                <button style="width:100%; padding:12px; border:none; border-radius:12px; background:#FFEEEE; color:var(--c-foul); font-weight:800;" onclick="clearAllData()">彻底清空（所有模式）</button>
                <button style="width:100%; padding:12px; border:none; border-radius:12px; background:#F2F2F7; color:#333; font-weight:650;" onclick="closeResetModal()">取消</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="logModal">
        <div class="center-box" style="width:320px;">
            <div style="font-size:18px; font-weight:800; margin-bottom:12px;">操作日志</div>
            <div id="logContent" style="max-height: 300px; overflow-y: auto; margin-bottom:16px;"></div>
            <button style="width:100%; padding:12px; background:#F2F2F7; color:#333; border:none; border-radius:12px; font-weight:600;" onclick="closeLogModal()">关闭</button>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="center-box">
            <div style="font-size:16px; font-weight:700; margin-bottom:12px;">设置</div>

            <div style="text-align:left; font-size:12px; color:#8E8E93; margin-bottom:6px;">游戏模式</div>
            <div class="setting-opt selected" id="optChase" onclick="setGameType('chase')">
                <div style="text-align:left; flex:1"><span style="font-weight:700;font-size:14px;">追分模式</span></div>
                <div style="color:var(--c-primary); font-weight:bold;">✓</div>
            </div>
            <div class="setting-opt" id="optCn8" onclick="setGameType('cn8')">
                <div style="text-align:left; flex:1"><span style="font-weight:700;font-size:14px;">中式八球</span></div>
                <div style="color:var(--c-primary); font-weight:bold; display:none;">✓</div>
            </div>
            
            <div id="playerCountSection">
                <div style="text-align:left; font-size:12px; color:#8E8E93; margin-bottom:6px;">人数模式</div>
                <div style="display:flex; background:#E5E5EA; border-radius:10px; padding:2px; margin-bottom:16px;">
                    <button class="toggle-btn" id="mode2" onclick="switchMode(2)" style="flex:1; padding:8px; border:none; background:transparent; border-radius:8px; font-weight:600; color:#888;">2人</button>
                    <button class="toggle-btn active" id="mode3" onclick="switchMode(3)" style="flex:1; padding:8px; border:none; background:#FFF; border-radius:8px; font-weight:600; box-shadow:0 1px 3px rgba(0,0,0,0.1);">3人</button>
                </div>
            </div>

            <div id="twoPlayerScoreModeSection">
                <div style="text-align:left; font-size:12px; color:#8E8E93; margin-bottom:6px;">2人局计分机制</div>
                <div class="setting-opt selected" id="optTransfer" onclick="setScoreMode('transfer')">
                    <div><span style="font-weight:600;font-size:14px;">给付制</span><div style="font-size:10px;color:#888">赢+10 输-10</div></div>
                    <div style="color:var(--c-primary); font-weight:bold;">✓</div>
                </div>
                <div class="setting-opt" id="optRace" onclick="setScoreMode('race')">
                    <div><span style="font-weight:600;font-size:14px;">抢分制</span><div style="font-size:10px;color:#888">赢+10 输0</div></div>
                    <div style="color:var(--c-primary); font-weight:bold; display:none;">✓</div>
                </div>
            </div>

            <div style="text-align:left; font-size:12px; color:#8E8E93; margin-bottom:6px;">结算规则</div>
            <div class="setting-opt" onclick="openRuleSetModal()">
                <div style="text-align:left; flex:1"><span style="font-weight:700;font-size:14px;">当前：<span id="activeRuleSetName">常规厅</span></span><div style="font-size:10px;color:#888">可配置普胜/小金/黑金等</div></div>
                <div style="color:var(--c-primary); font-weight:bold;">›</div>
            </div>

            <div class="setting-opt" onclick="openWizard(true)">
                <div style="text-align:left; flex:1"><span style="font-weight:700;font-size:14px;">开局向导</span><div style="font-size:10px;color:#888">模式→人数→名字→规则→开始</div></div>
                <div style="color:var(--c-primary); font-weight:bold;">›</div>
            </div>
            <div class="modal-btns" style="margin-top:16px;">
                <button style="background:var(--c-primary); color:#FFF; flex:1; padding:12px; border:none; border-radius:12px; font-size:15px; font-weight:600; width:100%" onclick="closeSettings()">完成</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="ruleSetModal">
        <div class="center-box" style="width:320px;">
            <div style="font-size:18px; font-weight:800; margin-bottom:12px;">结算规则</div>
            <div id="ruleSetList" style="max-height: 320px; overflow-y: auto; margin-bottom:14px;"></div>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button style="flex:1; padding:12px; border:none; border-radius:12px; background:#F2F2F7; color:#333; font-weight:650;" onclick="createRuleSet()">新建</button>
                <button style="flex:1; padding:12px; border:none; border-radius:12px; background:var(--c-primary); color:#FFF; font-weight:750;" onclick="openRuleEditor()">编辑</button>
            </div>
            <div style="display:flex; gap:10px;">
                <button style="flex:1; padding:12px; border:none; border-radius:12px; background:#FFEEEE; color:var(--c-foul); font-weight:800;" onclick="deleteActiveRuleSet()">删除</button>
                <button style="flex:1; padding:12px; border:none; border-radius:12px; background:#F2F2F7; color:#333; font-weight:650;" onclick="closeRuleSetModal()">关闭</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="ruleEditorModal">
        <div class="center-box" style="width:340px;">
            <div style="font-size:18px; font-weight:800; margin-bottom:10px;">规则编辑</div>
            <div style="font-size:12px; color:#8E8E93; margin-bottom:10px; text-align:left;">当前：<span id="ruleEditorTitle" style="font-weight:800;"></span></div>
            <div id="ruleEditorBody" style="max-height: 56vh; overflow-y: auto; text-align:left;"></div>
            <div style="display:flex; gap:10px; margin-top:14px;">
                <button style="flex:1; padding:12px; border:none; border-radius:12px; background:#F2F2F7; color:#333; font-weight:650;" onclick="closeRuleEditor()">取消</button>
                <button style="flex:1; padding:12px; border:none; border-radius:12px; background:var(--c-primary); color:#FFF; font-weight:750;" onclick="saveRuleEditor()">保存</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="wizardModal" style="z-index: 170;">
        <div class="center-box" style="width:340px;">
            <div id="wizardTitle" style="font-size:18px; font-weight:900; margin-bottom:8px;">开局向导</div>
            <div id="wizardStepHint" style="font-size:12px; color:#8E8E93; margin-bottom:10px;"></div>
            <div id="wizardBody" style="text-align:left;"></div>
            <div style="display:flex; gap:10px; margin-top:14px;">
                <button id="wizardBackBtn" style="flex:1; padding:12px; border:none; border-radius:12px; background:#F2F2F7; color:#333; font-weight:650;" onclick="wizardBack()">上一步</button>
                <button id="wizardNextBtn" style="flex:1; padding:12px; border:none; border-radius:12px; background:var(--c-primary); color:#FFF; font-weight:800;" onclick="wizardNext()">下一步</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="nameModal">
        <div class="center-box">
            <div style="font-size:16px; font-weight:700;">修改名字</div>
            <input type="text" class="modal-input" id="nameInput" placeholder="输入新名字" maxlength="8">
            <div id="nameQuickList"></div>
            <div style="display:flex; gap:10px;">
                <button style="flex:1; padding:10px; border:none; border-radius:12px; background:#F2F2F7; color:#8E8E93; font-weight:600;" onclick="closeNameModal()">取消</button>
                <button style="flex:1; padding:10px; border:none; border-radius:12px; background:var(--c-primary); color:#FFF; font-weight:600;" onclick="saveName()">确定</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="summaryModal">
        <div class="center-box" style="width: calc(100vw - 24px);">
            <div class="receipt-header">
                <div id="summaryTitle" style="font-size:20px; font-weight:800;">战局结算</div>
                <div id="summaryTime" style="font-size:12px; color:#8E8E93; margin-top:4px;"></div>
            </div>
            <div id="summaryContent" style="max-height: none; overflow: visible;"></div>
            <div id="summaryActionsRow" style="display:flex; gap:10px; margin-top:16px;">
                 <button style="flex:1; padding:12px; background:#F2F2F7; color:#333; border:none; border-radius:12px; font-weight:600;" onclick="closeSummary()">关闭</button>
                 <button style="flex:1; padding:12px; background:var(--c-primary); color:#FFF; border:none; border-radius:12px; font-weight:700;" onclick="copyReport()">复制战报</button>
                 <button style="flex:1; padding:12px; background:#1C1C1E; color:#FFF; border:none; border-radius:12px; font-weight:700;" onclick="generatePoster()">生成图片</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="posterModal">
        <div class="center-box">
            <div style="font-size:16px; font-weight:800; margin-bottom:10px;">图片战报</div>
            <img id="posterImg" alt="poster" />
            <div class="poster-btn-row">
                <button style="flex:1; padding:12px; background:#F2F2F7; color:#333; border:none; border-radius:12px; font-weight:650;" onclick="closePosterModal()">关闭</button>
                <button style="flex:1; padding:12px; background:var(--c-primary); color:#FFF; border:none; border-radius:12px; font-weight:750;" onclick="savePosterImage()">保存图片</button>
                <button style="flex:1; padding:12px; background:#1C1C1E; color:#FFF; border:none; border-radius:12px; font-weight:750;" onclick="sharePosterImage()">分享</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="script.js"></script>
</body>
</html>
