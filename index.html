<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#F2F2F7">
    <title>æ¡Œçƒè¿½åˆ† (è”æœºç‰ˆ)</title>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ï¼Œä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œçœç•¥äº†æœªä¿®æ”¹çš„CSS */
        :root {
            --bg-body: #F2F2F7; --bg-card: #FFFFFF;
            --c-primary: #007AFF; --c-gold-s: #FF9500; --c-gold-b: #AF52DE; --c-gold-9: #FFD60A; 
            --c-black: #2C2C2E; --c-foul: #FF3B30; --c-let: #FF2D55;      
            --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background-color: var(--bg-body); margin: 0; padding: 0;
            height: 100dvh; overflow: hidden; display: flex; flex-direction: column;
            padding-top: max(10px, var(--safe-top)); padding-bottom: max(10px, var(--safe-bottom));
            box-sizing: border-box; user-select: none; -webkit-user-select: none;
        }
        header {
            flex-shrink: 0; height: 44px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; position: relative;
        }
        .header-left { display: flex; gap: 8px; z-index: 2; }
        .icon-btn {
            background: none; border: none; padding: 6px; color: var(--c-primary); 
            display: flex; align-items: center; cursor: pointer; border-radius: 50%;
        }
        .header-center {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center; z-index: 1; pointer-events: none;
        }
        .room-id-display {
            font-size: 10px; color: #8E8E93; margin-top: 2px; font-family: monospace;
        }
        .toggle-box {
            background: #E5E5EA; border-radius: 100px; padding: 2px; display: flex; pointer-events: auto;
        }
        .toggle-btn {
            border: none; background: none; padding: 2px 12px; border-radius: 100px;
            font-size: 13px; font-weight: 600; color: #8E8E93; transition: all 0.2s;
        }
        .toggle-btn.active { background: #FFF; color: #000; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .reset-btn { 
            border: none; background: none; color: var(--c-foul); font-size: 15px; font-weight: 600; 
            cursor: pointer; z-index: 2;
        }
        .round-indicator-bar {
            text-align: center; font-size: 13px; font-weight: 600; color: #8E8E93;
            padding: 6px 0;
        }
        main {
            flex: 1; display: flex; flex-direction: column; justify-content: space-evenly;
            padding: 0 16px; gap: 10px; overflow: hidden; padding-bottom: 8px;
        }
        .player-card {
            background: var(--bg-card); border-radius: 18px; padding: 10px 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            display: flex; flex-direction: column; justify-content: center; flex: 1; min-height: 0; 
            transition: transform 0.3s ease;
        }
        .card-header-row {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; flex-shrink: 0;
        }
        .left-info { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .rank-num {
            width: 22px; height: 22px; background: var(--c-primary); color: white; 
            font-size: 13px; font-weight: 700; border-radius: 6px; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 122, 255, 0.3);
        }
        .p-name { font-size: 17px; font-weight: 600; color: #333; }
        .p-score { font-size: 32px; font-weight: 800; line-height: 1; font-variant-numeric: tabular-nums; }
        .score-p { color: #34C759; } .score-n { color: #FF3B30; } .score-z { color: #1C1C1E; }
        .btn-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(2, 1fr);
            gap: 5px; flex: 1; min-height: 0; 
        }
        .act-btn {
            border: none; border-radius: 10px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; cursor: pointer; padding: 2px 0;
        }
        .act-btn:active { opacity: 0.6; transform: scale(0.96); }
        .btn-t { font-size: 13px; font-weight: 600; margin-bottom: 1px; white-space: nowrap; }
        .btn-s { font-size: 9px; opacity: 0.75; font-weight: 500; letter-spacing: -0.3px; white-space: nowrap; }
        .b-norm { background: #E1F0FF; color: var(--c-primary); }
        .b-sgold { background: #FFF3DC; color: var(--c-gold-s); }
        .b-bgold { background: #F3E5F5; color: var(--c-gold-b); }
        .b-gold9 { background: #FFFDE7; color: #9A7D0A; } 
        .b-black { background: #3A3A3C; color: #FFF; }
        .b-foul { background: #FFEEEE; color: var(--c-foul); }
        .b-let { background: #FFF0F5; color: var(--c-let); }
        footer {
            flex-shrink: 0; display: flex; justify-content: space-between;
            padding: 0 16px; gap: 12px; height: 42px;
        }
        .footer-btn {
            flex: 1; border-radius: 21px; display: flex; align-items: center; justify-content: center; gap: 6px;
            font-size: 14px; font-weight: 600; border: none; cursor: pointer;
        }
        .btn-undo { background: #FFF; color: #555; border: 1px solid #E5E5EA; }
        .btn-save { background: #1C1C1E; color: #FFF; }
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            z-index: 100; display: none; opacity: 0; transition: opacity 0.25s;
            justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        .center-box {
            background: #FFF; width: 300px; max-width: 90%; border-radius: 18px; 
            padding: 20px; text-align: center; transform: scale(0.9); transition: transform 0.2s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto;
        }
        .modal-overlay.show .center-box { transform: scale(1); }
        .modal-input {
            width: 100%; box-sizing: border-box;
            padding: 12px; background: #F2F2F7; border: none; border-radius: 12px; 
            margin: 16px 0; text-align: center; font-size: 16px;
        }
        .setting-opt {
            background: #F2F2F7; padding: 10px; border-radius: 10px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .setting-opt.selected { background: #E1F0FF; border: 1px solid var(--c-primary); }
        .res-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-top: 4px; }
        .stat-badge {
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; padding: 4px 2px; border-radius: 4px; 
            font-weight: 600; margin: 0; white-space: nowrap;
        }
        .sb-gold { background: #F3E5F5; color: var(--c-gold-b); }
        .sb-small { background: #FFF3DC; color: var(--c-gold-s); }
        .sb-g9 { background: #FFFDE7; color: #9A7D0A; }
        .sb-win { background: #E1F0FF; color: var(--c-primary); }
        .result-row { display: flex; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid #F2F2F7; }
        .res-rank { font-size: 24px; width: 36px; padding-top: 0px; text-align: center;}
        .res-name { flex: 1; text-align: left; font-weight: 700; font-size: 16px; margin-bottom: 4px;}
        .res-score { font-weight: 800; font-size: 18px; }
        
        /* ç¦»çº¿/è¿æ¥çŠ¶æ€æç¤º */
        #status-bar {
            position: absolute; top: 0; left:0; right:0; height: 4px; background: #ccc; z-index: 10;
        }
    </style>
</head>
<body>
    <div id="status-bar"></div>

    <header>
        <div class="header-left">
            <button class="icon-btn" onclick="openSettings()">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <button class="icon-btn" onclick="copyLink()">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
        </div>

        <div class="header-center">
            <div class="toggle-box">
                <button class="toggle-btn" id="mode2" onclick="switchMode(2)">2äºº</button>
                <button class="toggle-btn active" id="mode3" onclick="switchMode(3)">3äºº</button>
            </div>
            <div class="room-id-display" id="roomIdDisp">æˆ¿é—´: ...</div>
        </div>

        <button class="reset-btn" onclick="resetGame()">é‡ç½®</button>
    </header>
    
    <div id="roundDisplay" class="round-indicator-bar">è¿æ¥ä¸­...</div>

    <main id="container"></main>

    <footer>
        <button class="footer-btn btn-undo" onclick="undo()">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" stroke-linecap="round" stroke-linejoin="round"/></svg>æ’¤é”€
        </button>
        <button class="footer-btn btn-save" onclick="handleSettleNow(); return false;">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"/></svg>ç»“ç®—
        </button>
    </footer>

    <div class="modal-overlay" id="settingsModal">
        <div class="center-box">
            <div style="font-size:16px; font-weight:700; margin-bottom:12px;">è®¾ç½®è§„åˆ™</div>
            <div style="text-align:left; font-size:12px; color:#8E8E93; margin-bottom:6px;">2äººå±€è®¡åˆ†æœºåˆ¶</div>
            <div class="setting-opt selected" id="optTransfer" onclick="setScoreMode('transfer')">
                <div><span style="font-weight:600;font-size:14px;">ç»™ä»˜åˆ¶</span><div style="font-size:10px;color:#888">èµ¢+10 è¾“-10</div></div>
                <div style="color:var(--c-primary); font-weight:bold;">âœ“</div>
            </div>
            <div class="setting-opt" id="optRace" onclick="setScoreMode('race')">
                <div><span style="font-weight:600;font-size:14px;">æŠ¢åˆ†åˆ¶</span><div style="font-size:10px;color:#888">èµ¢+10 è¾“0</div></div>
                <div style="color:var(--c-primary); font-weight:bold; display:none;">âœ“</div>
            </div>
            <div class="modal-btns" style="margin-top:16px;">
                <button class="m-btn" style="background:var(--c-primary); color:#FFF; flex:1; padding:10px; border:none; border-radius:12px; font-size:15px; font-weight:600; width:100%" onclick="closeSettings()">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="nameModal">
        <div class="center-box">
            <div style="font-size:16px; font-weight:700;">ä¿®æ”¹åå­—</div>
            <input type="text" class="modal-input" id="nameInput" placeholder="è¾“å…¥æ–°åå­—" maxlength="8">
            <div style="display:flex; gap:10px;">
                <button style="flex:1; padding:10px; border:none; border-radius:12px; background:#F2F2F7; color:#8E8E93; font-weight:600;" onclick="closeNameModal()">å–æ¶ˆ</button>
                <button style="flex:1; padding:10px; border:none; border-radius:12px; background:var(--c-primary); color:#FFF; font-weight:600;" onclick="saveName()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="summaryModal">
        <div class="center-box" style="width:320px;">
            <div id="summaryTitle" style="font-size:18px; font-weight:800; margin-bottom:4px;">æˆ˜å±€ç»“ç®—</div>
            <div style="font-size:12px; color:#8E8E93; margin-bottom:16px;">ç»Ÿè®¡å·²å®Œæˆ</div>
            <div id="summaryContent"></div>
            <button style="width:100%; margin-top:16px; padding:12px; background:var(--c-primary); color:#FFF; border:none; border-radius:12px; font-weight:600;" onclick="closeSummary()">å…³é—­</button>
        </div>
    </div>

    <script type="module">
        // 1. å¼•å…¥ Firebase åº“
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --------------------------------------------------------
        // ğŸ”¥ åœ¨è¿™é‡Œå¡«å…¥ä½ çš„ Firebase é…ç½® (ä»æ§åˆ¶å°å¤åˆ¶) ğŸ”¥
        // --------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyADNOZ3t-TrqLBU2rLf2QAUv77-b-vzSR0",
              authDomain: "billiards-score.firebaseapp.com",
              databaseURL: "https://billiards-score-default-rtdb.firebaseio.com",
              projectId: "billiards-score",
              storageBucket: "billiards-score.firebasestorage.app",
              messagingSenderId: "708415656794",
              appId: "1:708415656794:web:ba7775bb8b33924c6c1963",
              measurementId: "G-1523P4CF20"
        };
        // --------------------------------------------------------

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // è·å–æˆ–ç”Ÿæˆæˆ¿é—´å·
        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room');
        if (!roomId) {
            roomId = Math.random().toString(36).substring(2, 8); // ç”Ÿæˆéšæœºæˆ¿é—´å·
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + roomId;
            window.history.pushState({path:newUrl},'',newUrl);
        }
        document.getElementById('roomIdDisp').innerText = `æˆ¿å·: ${roomId}`;

        // å…¨å±€çŠ¶æ€ (æœ¬åœ°å‰¯æœ¬)
        const emptyStats = () => ({ bigGold: 0, smallGold: 0, gold9: 0, normal: 0 });
        // é»˜è®¤çŠ¶æ€
        let state = {
            mode: 3,
            round: 0, 
            scoreMode: 'transfer', 
            players: [
                { id: 0, name: 'ç©å®¶ A', score: 0, stats: emptyStats() },
                { id: 1, name: 'ç©å®¶ B', score: 0, stats: emptyStats() },
                { id: 2, name: 'ç©å®¶ C', score: 0, stats: emptyStats() }
            ],
            history: [] // å†å²è®°å½•å­˜åœ¨æ•°æ®åº“é‡Œå¤ªå¤æ‚ï¼Œè¿™é‡Œç®€åŒ–ï¼šæ¯æ¬¡å˜åŠ¨éƒ½å­˜æ•´ä¸ªå¿«ç…§ï¼Œæ’¤é”€æ—¶å›æ»š
        };
        
        let currentEditIndex = -1;

        // --- æ ¸å¿ƒç½‘ç»œé€»è¾‘ ---

        const roomRef = ref(db, 'rooms/' + roomId);
        const statusEl = document.getElementById('status-bar');

        // 1. ç›‘å¬æ•°æ®åº“å˜åŒ– (æ‰€æœ‰äººéƒ½ä¼šæ”¶åˆ°)
        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            statusEl.style.backgroundColor = '#34C759'; // ç»¿è‰²è¡¨ç¤ºè¿æ¥æˆåŠŸ
            if (data) {
                // å¦‚æœæ•°æ®åº“é‡Œæœ‰æ•°æ®ï¼ŒåŒæ­¥åˆ°æœ¬åœ°
                state = data;
                // ç¡®ä¿ history ä¹Ÿæ˜¯æ•°ç»„
                if (!state.history) state.history = [];
            } else {
                // å¦‚æœæ•°æ®åº“æ˜¯ç©ºçš„ï¼ˆæ–°æˆ¿é—´ï¼‰ï¼ŒæŠŠé»˜è®¤æ•°æ®æ¨ä¸Šå»
                pushStateToCloud();
            }
            updateUI(); // æ¸²æŸ“ç•Œé¢
        }, (error) => {
            statusEl.style.backgroundColor = '#FF3B30'; // çº¢è‰²è¡¨ç¤ºå‡ºé”™
            console.error(error);
        });

        // 2. å°†æœ¬åœ°çŠ¶æ€æ¨é€åˆ°äº‘ç«¯
        function pushStateToCloud() {
            set(roomRef, state);
        }

        // --- æ¸¸æˆé€»è¾‘ (ä¿®æ”¹ä¸ºåªæ“ä½œæ•°æ®ï¼Œæœ€åè°ƒç”¨ pushStateToCloud) ---

        function getRelations(curr, total) {
            return { prev: (curr - 1 + total) % total, next: (curr + 1) % total };
        }

        function rotateWinner(winnerIdx) {
            if (state.mode === 3) {
                if (winnerIdx === 0) {
                    [state.players[1], state.players[2]] = [state.players[2], state.players[1]];
                } else {
                    [state.players[0], state.players[winnerIdx]] = [state.players[winnerIdx], state.players[0]];
                }
            } else if (state.mode === 2) {
                if (winnerIdx !== 0) {
                     [state.players[0], state.players[1]] = [state.players[1], state.players[0]];
                }
            }
        }

        // ç»‘å®šåˆ° window ä»¥ä¾¿ HTML onclick è°ƒç”¨
        window.handleAction = function(idx, type) {
            // è®°å½•å†å²ç”¨äºæ’¤é”€ (æœ€å¤šå­˜20æ­¥)
            if (state.history.length > 20) state.history.shift();
            // æ·±æ‹·è´å½“å‰æ•°æ®åˆ°å†å²ï¼Œä½†ä¸åŒ…æ‹¬ history å­—æ®µæœ¬èº«é¿å…é€’å½’
            const stateSnapshot = JSON.parse(JSON.stringify({
                mode: state.mode,
                round: state.round,
                scoreMode: state.scoreMode,
                players: state.players
            }));
            state.history.push(stateSnapshot);

            // ä¿®æ”¹çŠ¶æ€
            state.round++;
            const total = state.mode;
            const { prev, next } = getRelations(idx, total);
            let ps = state.players;
            const scores = { normal: 4, smallGold: 7, bigGold: 20, gold9: 8 };

            if (!ps[idx].stats) ps[idx].stats = emptyStats();
            let isWin = false;

            if (['normal','smallGold','bigGold','gold9'].includes(type)) isWin = true;
            if (type === 'normal') ps[idx].stats.normal++;
            else if (type === 'smallGold') ps[idx].stats.smallGold++;
            else if (type === 'bigGold') ps[idx].stats.bigGold++;
            else if (type === 'gold9') ps[idx].stats.gold9++;

            if (total === 3) {
                switch (type) {
                    case 'normal': ps[idx].score += 4; ps[prev].score -= 4; break;
                    case 'smallGold': ps[idx].score += 7; ps[prev].score -= 7; break;
                    case 'bigGold': ps[idx].score += 20; ps[prev].score -= 10; ps[next].score -= 10; break;
                    case 'gold9': ps[idx].score += 8; ps[prev].score -= 4; ps[next].score -= 4; break;
                    case 'foul': ps[idx].score -= 1; ps[prev].score += 1; break;
                    case 'letFoul': ps[idx].score -= 1; ps[next].score += 1; break;
                    case 'openFoul': ps[idx].score -= 1; ps[next].score += 1; break;
                    case 'blackGold': ps[idx].score -= 5; ps[prev].score += 1; ps[next].score += 4; break;
                }
            } else if (total === 2) {
                const isRace = state.scoreMode === 'race'; 
                const opponentIdx = next;
                switch (type) {
                    case 'normal': ps[idx].score += scores.normal; if (!isRace) ps[opponentIdx].score -= scores.normal; break;
                    case 'smallGold': ps[idx].score += scores.smallGold; if (!isRace) ps[opponentIdx].score -= scores.smallGold; break;
                    case 'bigGold': ps[idx].score += 10; if (!isRace) ps[opponentIdx].score -= 10; break;
                    case 'gold9': ps[idx].score += 4; if (!isRace) ps[opponentIdx].score -= 4; break;
                    case 'foul': ps[idx].score -= 1; if (!isRace) ps[opponentIdx].score += 1; break;
                    case 'letFoul': ps[idx].score -= 1; if (!isRace) ps[opponentIdx].score += 1; break;
                    case 'openFoul': ps[idx].score -= 1; if (!isRace) ps[opponentIdx].score += 1; break;
                    case 'blackGold': ps[idx].score -= 5; if (!isRace) ps[opponentIdx].score += 5; break;
                }
            }

            if (isWin) rotateWinner(idx);

            // ğŸ”¥ æ¨é€åˆ°äº‘ç«¯
            pushStateToCloud();
            if(navigator.vibrate) navigator.vibrate(15);
        };

        window.undo = function() {
            if (!state.history || state.history.length === 0) return alert("æ²¡æœ‰æ“ä½œå¯æ’¤é”€");
            const previous = state.history.pop();
            
            // æ¢å¤çŠ¶æ€
            state.mode = previous.mode;
            state.round = previous.round;
            state.scoreMode = previous.scoreMode;
            state.players = previous.players;
            
            // ğŸ”¥ æ¨é€åˆ°äº‘ç«¯
            pushStateToCloud();
        };

        window.resetGame = function() {
            if (confirm("ç¡®å®šé‡ç½®?")) {
                state.round = 0;
                state.history = []; 
                state.players.forEach(p => { p.score = 0; p.stats = emptyStats(); }); 
                // ğŸ”¥ æ¨é€åˆ°äº‘ç«¯
                pushStateToCloud();
            }
        };

        window.switchMode = function(n) {
            if (state.mode === n) return;
            if (!confirm('åˆ‡æ¢äººæ•°ä¼šé‡ç½®æ¯”åˆ†')) return;
            state.mode = n;
            state.round = 0; 
            state.history = []; state.players = [];
            const defs = ['ç©å®¶ A', 'ç©å®¶ B', 'ç©å®¶ C'];
            for(let i=0; i<n; i++) state.players.push({ id: i, name: defs[i], score: 0, stats: emptyStats() });
            pushStateToCloud();
        };

        window.saveName = function() { 
            const val = document.getElementById('nameInput').value.trim(); 
            if(val) { 
                state.players[currentEditIndex].name = val; 
                pushStateToCloud(); 
            } 
            closeNameModal(); 
        };

        window.setScoreMode = function(mode) { 
            state.scoreMode = mode; 
            // è¿™é‡Œçš„ openSettings æ˜¯ UI åŠ¨ä½œï¼Œä¸éœ€è¦æ¨é€ï¼Œä½†ä¿®æ”¹äº† mode éœ€è¦æ¨é€å—ï¼Ÿ
            // è§„åˆ™ä¿®æ”¹é€šå¸¸ä¹Ÿéœ€è¦åŒæ­¥ï¼Œæ‰€ä»¥æ¨é€ï¼š
            pushStateToCloud();
            openSettings(); 
        };

        // --- UI æ¸²æŸ“ (é€»è¾‘ä¸å˜) ---

        function updateUI() {
            // æ›´æ–°å›åˆ
            document.getElementById('roundDisplay').innerText = `ç¬¬ ${state.round} å›åˆ`;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('mode2').className = state.mode === 2 ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('mode3').className = state.mode === 3 ? 'toggle-btn active' : 'toggle-btn';

            // æ›´æ–°è®¾ç½®å¼¹çª—çŠ¶æ€
            const optTransfer = document.getElementById('optTransfer');
            const optRace = document.getElementById('optRace');
            if (state.scoreMode === 'transfer') {
                optTransfer.classList.add('selected'); optTransfer.querySelector('div:last-child').style.display = 'block';
                optRace.classList.remove('selected'); optRace.querySelector('div:last-child').style.display = 'none';
            } else {
                optRace.classList.add('selected'); optRace.querySelector('div:last-child').style.display = 'block';
                optTransfer.classList.remove('selected'); optTransfer.querySelector('div:last-child').style.display = 'none';
            }

            // æ¸²æŸ“ç©å®¶å¡ç‰‡
            const box = document.getElementById('container');
            box.innerHTML = '';
            
            let txtBig = 'é€šåƒ 20'; let txtG9 = 'é€šåƒ 8'; let txtBlack = 'ä¸Š+1 ä¸‹+4';
            if (state.mode === 2) {
                if (state.scoreMode === 'transfer') { 
                    txtBig = 'è‡ª+10 ä»–-10'; txtG9 = 'è‡ª+4 ä»–-4'; txtBlack = 'è‡ª-5 ä»–+5';
                } else { 
                    txtBig = 'è‡ª+10'; txtG9 = 'è‡ª+4'; txtBlack = 'è‡ª-5';
                }
            }

            state.players.forEach((p, i) => {
                let sc = p.score > 0 ? 'score-p' : (p.score < 0 ? 'score-n' : 'score-z');
                let sig = p.score > 0 ? '+' : '';
                const el = document.createElement('div');
                el.className = 'player-card';
                el.innerHTML = `
                    <div class="card-header-row">
                        <div class="left-info" onclick="openNameModal(${i})">
                            <div class="rank-num">${i + 1}</div>
                            <div class="p-name">${p.name}</div>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="#CCC"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/></svg>
                        </div>
                        <div class="p-score ${sc}">${sig}${p.score}</div>
                    </div>
                    <div class="btn-grid">
                        <button class="act-btn b-bgold" onclick="handleAction(${i}, 'bigGold')"><span class="btn-t">å¤§é‡‘</span><span class="btn-s">${txtBig}</span></button>
                        <button class="act-btn b-sgold" onclick="handleAction(${i}, 'smallGold')"><span class="btn-t">å°é‡‘</span><span class="btn-s">è‡ª+7 ä¸Š-7</span></button>
                        <button class="act-btn b-gold9" onclick="handleAction(${i}, 'gold9')"><span class="btn-t">é»„é‡‘9</span><span class="btn-s">${txtG9}</span></button>
                        <button class="act-btn b-black" onclick="handleAction(${i}, 'blackGold')"><span class="btn-t">é»‘é‡‘</span><span class="btn-s">${txtBlack}</span></button>
                        <button class="act-btn b-norm" onclick="handleAction(${i}, 'normal')"><span class="btn-t">æ™®èƒœ</span><span class="btn-s">è‡ª+4 ä¸Š-4</span></button>
                        <button class="act-btn b-foul" onclick="handleAction(${i}, 'foul')"><span class="btn-t">çŠ¯è§„</span><span class="btn-s">ç»™ä¸Šå®¶ 1</span></button>
                        <button class="act-btn b-let" onclick="handleAction(${i}, 'letFoul')"><span class="btn-t">è®©æ†çŠ¯è§„</span><span class="btn-s">ç»™ä¸‹å®¶ 1</span></button>
                        <button class="act-btn b-foul" style="background:#FFEAEA" onclick="handleAction(${i}, 'openFoul')"><span class="btn-t">å¼€çƒçŠ¯è§„</span><span class="btn-s">ç»™ä¸‹å®¶ 1</span></button>
                    </div>
                `;
                box.appendChild(el);
            });
        }

        // --- çº¯ UI è¾…åŠ©å‡½æ•° (å¼¹çª—å¼€å…³ç­‰ï¼Œä¸éœ€è¦è”ç½‘) ---
        window.openSettings = function() { 
            document.getElementById('settingsModal').style.display = 'flex'; 
            setTimeout(() => document.getElementById('settingsModal').classList.add('show'), 10); 
        };
        window.closeSettings = function() { 
            document.getElementById('settingsModal').classList.remove('show'); 
            setTimeout(() => document.getElementById('settingsModal').style.display = 'none', 200); 
        };
        window.openNameModal = function(i) { currentEditIndex = i; document.getElementById('nameInput').value = ''; document.getElementById('nameModal').style.display = 'flex'; setTimeout(() => document.getElementById('nameModal').classList.add('show'), 10); setTimeout(() => document.getElementById('nameInput').focus(), 50); };
        window.closeNameModal = function() { document.getElementById('nameModal').classList.remove('show'); setTimeout(() => { document.getElementById('nameModal').style.display = 'none'; document.getElementById('nameInput').blur(); }, 200); };
        window.handleSettleNow = function() { showSummary(); };
        window.closeSummary = function() { document.getElementById('summaryModal').classList.remove('show'); setTimeout(() => document.getElementById('summaryModal').style.display = 'none', 300); };

        function showSummary() {
            document.getElementById('summaryTitle').innerText = `æˆ˜å±€ç»“ç®— (å…± ${state.round} å›åˆ)`;
            const sortedPlayers = [...state.players].sort((a, b) => b.score - a.score);
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            let html = '';
            sortedPlayers.forEach((p, idx) => {
                const medal = medals[idx] || (idx + 1);
                const color = p.score > 0 ? '#34C759' : (p.score < 0 ? '#FF3B30' : '#000');
                const sign = p.score > 0 ? '+' : '';
                const st = p.stats || emptyStats();
                html += `
                    <div class="result-row">
                        <div class="res-rank">${medal}</div>
                        <div style="flex:1;">
                            <div style="display:flex; justify-content:space-between;">
                                <span class="res-name">${p.name}</span>
                                <span class="res-score" style="color:${color}">${sign}${p.score}</span>
                            </div>
                            <div class="res-stats">
                                <span class="stat-badge sb-gold">å¤§é‡‘:${st.bigGold}</span>
                                <span class="stat-badge sb-small">å°é‡‘:${st.smallGold}</span>
                                <span class="stat-badge sb-g9">é»„é‡‘9:${st.gold9}</span>
                                <span class="stat-badge sb-win">æ™®èƒœ:${st.normal}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('summaryContent').innerHTML = html;
            const modal = document.getElementById('summaryModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        window.copyLink = function() {
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({ title: 'æ¡Œçƒè¿½åˆ†', url: url }).catch(console.error);
            } else {
                navigator.clipboard.writeText(url).then(() => alert('é“¾æ¥å·²å¤åˆ¶ï¼Œå‘ç»™å¥½å‹å³å¯è”æœº'));
            }
        };

        // åˆå§‹è¿è¡Œä¸€æ¬¡ UI æ¸²æŸ“ (æ˜¾ç¤ºè¿æ¥ä¸­çŠ¶æ€)
        updateUI();

    </script>
</body>
</html>
