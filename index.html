<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>æ¡Œçƒè®°åˆ† Ultimate</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        /* --- 1. æ ¸å¿ƒå˜é‡ & æ·±è‰²æ¨¡å¼é€‚é… --- */
        :root {
            --bg-body: #F2F2F7; --bg-card: #FFFFFF; --bg-header: rgba(242,242,247,0.85);
            --t-main: #000000; --t-sec: #8E8E93; 
            --c-blue: #007AFF; --c-red: #FF3B30; --c-gold: #FFD60A; --c-purple: #AF52DE;
            --btn-bg: #E5E5EA; --shadow: 0 4px 12px rgba(0,0,0,0.06);
            --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #000000; --bg-card: #1C1C1E; --bg-header: rgba(28,28,30,0.85);
                --t-main: #FFFFFF; --t-sec: #98989D;
                --btn-bg: #2C2C2E; --shadow: 0 4px 12px rgba(0,0,0,0.4);
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background: var(--bg-body); color: var(--t-main);
            margin: 0; height: 100dvh; display: flex; flex-direction: column;
            padding-top: max(10px, var(--safe-top)); padding-bottom: max(10px, var(--safe-bottom));
            user-select: none; -webkit-user-select: none; touch-action: manipulation;
            transition: background 0.3s, color 0.3s;
        }

        /* --- 2. å¸ƒå±€ç»„ä»¶ --- */
        header {
            height: 44px; display: flex; justify-content: space-between; align-items: center; padding: 0 16px;
            position: sticky; top: 0; z-index: 10; backdrop-filter: blur(10px); background: var(--bg-header);
        }
        .icon-btn { background:none; border:none; color:var(--c-blue); padding:8px; cursor:pointer; }
        
        .timer-box {
            font-family: "SF Mono", monospace; font-size: 16px; font-weight: 600;
            background: var(--btn-bg); padding: 4px 12px; border-radius: 8px; min-width: 80px; text-align: center;
        }
        .timer-box.paused { opacity: 0.6; }

        .info-bar {
            margin: 8px 16px; background: var(--bg-card); border-radius: 12px; padding: 10px 16px;
            display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow);
            height: 60px;
        }
        .round-display { text-align: center; line-height: 1; }
        .round-display b { font-size: 24px; display: block; }
        .round-display span { font-size: 10px; color: var(--t-sec); }

        main { flex: 1; overflow-y: auto; padding: 10px 16px; display: flex; flex-direction: column; gap: 10px; }

        /* --- 3. è¿½åˆ†æ¨¡å¼å¡ç‰‡ (Chase Card) --- */
        .chase-card {
            background: var(--bg-card); border-radius: 16px; padding: 12px; box-shadow: var(--shadow);
            display: flex; flex-direction: column; gap: 8px; position: relative; border: 1.5px solid transparent;
        }
        .chase-card.dealer { border-color: var(--c-gold); background: linear-gradient(135deg, var(--bg-card), rgba(255,214,10,0.05)); }
        
        .c-header { display: flex; justify-content: space-between; align-items: center; }
        .c-score { font-size: 32px; font-weight: 800; font-variant-numeric: tabular-nums; }
        .score-p { color: #34C759; } .score-n { color: #FF3B30; }
        
        .btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .act-btn {
            border: none; background: var(--btn-bg); border-radius: 8px; padding: 10px 0;
            display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; overflow: hidden;
        }
        .act-btn:active { transform: scale(0.96); }
        .act-btn:disabled { opacity: 0.3; }
        .btn-l { font-size: 13px; font-weight: 700; color: var(--t-main); }
        .btn-s { font-size: 9px; opacity: 0.7; color: var(--t-sec); }

        /* --- 4. ä¸­å¼å…«çƒæ¨¡å¼å¡ç‰‡ (CN8 Card) - æ‰¾å›çš„åŠŸèƒ½ --- */
        .cn8-card {
            flex: 1; border-radius: 18px; padding: 20px; color: #FFF;
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); cursor: pointer; transition: transform 0.1s;
            min-height: 140px;
        }
        .cn8-card:active { transform: scale(0.98); }
        .cn8-red { background: linear-gradient(135deg, #FF3B30, #FF9500); }
        .cn8-blue { background: linear-gradient(135deg, #007AFF, #5856D6); }
        
        .cn8-name { font-size: 20px; font-weight: 700; opacity: 0.9; }
        .cn8-score { font-size: 80px; font-weight: 900; align-self: flex-end; line-height: 1; }
        .cn8-vs { text-align: center; font-size: 24px; font-weight: 900; opacity: 0.2; margin: -5px 0; font-style: italic; }

        /* --- 5. Footer & Modals --- */
        footer { padding: 10px 16px; display: flex; gap: 10px; }
        .f-btn { flex: 1; height: 44px; border-radius: 22px; border: none; font-weight: 600; font-size: 15px; cursor: pointer; }
        .b-undo { background: var(--bg-card); color: var(--t-main); box-shadow: var(--shadow); }
        .b-save { background: var(--t-main); color: var(--bg-body); box-shadow: var(--shadow); }

        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 100; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s;
        }
        .modal.show { display: flex; opacity: 1; }
        .box {
            background: var(--bg-card); width: 85%; max-width: 360px; border-radius: 20px;
            padding: 24px; text-align: center; max-height: 85vh; overflow-y: auto;
        }
        
        /* èµ°åŠ¿å›¾å®¹å™¨ */
        .trend-box { width: 100%; height: 150px; margin: 15px 0; background: var(--btn-bg); border-radius: 10px; padding: 10px; box-sizing: border-box;}

        /* å‘å¯¼æ ·å¼ */
        .wiz-opt {
            padding: 15px; border: 2px solid var(--btn-bg); border-radius: 12px; margin-bottom: 10px;
            font-weight: 600; text-align: left; transition: 0.2s; display: flex; justify-content: space-between;
        }
        .wiz-opt.selected { border-color: var(--c-blue); background: rgba(0,122,255,0.05); color: var(--c-blue); }

        /* åŠ¨ç”» */
        @keyframes pop { 0%{transform:scale(1);} 50%{transform:scale(1.3);} 100%{transform:scale(1);} }
    </style>
</head>
<body>

    <header>
        <button class="icon-btn" onclick="openWizard(true)">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
        </button>
        <div class="timer-box paused" id="timerDisplay" onclick="toggleTimer()">00:00</div>
        <button class="icon-btn" onclick="openSettings()">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        </button>
    </header>

    <div class="info-bar">
        <div id="logArea" style="font-size:11px; color:var(--t-sec); width:120px; white-space:nowrap; overflow:hidden;">å‡†å¤‡å¼€å±€</div>
        <div class="round-display">
            <b id="roundNum">0</b><span>å›åˆ</span>
        </div>
        <div id="leaderboard" style="font-size:11px; text-align:right;"></div>
    </div>

    <main id="gameContainer"></main>

    <footer>
        <button class="f-btn b-undo" onclick="undo()">æ’¤é”€</button>
        <button class="f-btn b-save" onclick="showSummary()">ç»“ç®—/æˆ˜æŠ¥</button>
    </footer>

    <div class="modal" id="wizardModal">
        <div class="box">
            <h2 style="margin-top:0">å¼€å§‹æ–°å±€</h2>
            <div id="wizStep1">
                <div class="wiz-opt selected" onclick="selectWizMode('cn8', this)">
                    <span>ğŸ± ä¸­å¼å…«çƒ</span><span>1v1</span>
                </div>
                <div class="wiz-opt" onclick="selectWizMode('chase', this)">
                    <span>ğŸ”„ å¤šäººè¿½åˆ†</span><span>2-3äºº</span>
                </div>
                <div id="chaseOpts" style="display:none; margin-top:10px; padding-left:10px;">
                    <label><input type="radio" name="pCount" value="2"> 2äººå±€</label>
                    <label style="margin-left:15px"><input type="radio" name="pCount" value="3" checked> 3äººå±€</label>
                </div>
                <button class="f-btn b-save" style="width:100%; margin-top:20px" onclick="startGame()">å¼€å§‹</button>
            </div>
        </div>
    </div>

    <div class="modal" id="summaryModal">
        <div class="box" id="summaryContent">
            <h2 style="margin-top:0">æˆ˜å±€ç»“ç®—</h2>
            <div style="font-size:12px; color:var(--t-sec); margin-bottom:15px;" id="sumTime"></div>
            
            <div class="trend-box" id="trendChart"></div>
            
            <div id="sumList" style="text-align:left; margin-bottom:20px;"></div>
            
            <div style="display:flex; gap:10px;">
                <button class="f-btn b-undo" onclick="closeModal('summaryModal')">å…³é—­</button>
                <button class="f-btn b-save" onclick="generateImage()">ç”Ÿæˆå›¾ç‰‡</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="settingsModal">
        <div class="box">
            <h3>è§„åˆ™é…ç½® (è¿½åˆ†)</h3>
            <div id="ruleInputs" style="text-align:left; font-size:14px;"></div>
            <button class="f-btn b-save" style="width:100%; margin-top:20px" onclick="closeModal('settingsModal')">ä¿å­˜</button>
            <button class="f-btn" style="width:100%; margin-top:10px; color:red" onclick="resetGame()">é‡ç½®æœ¬å±€</button>
        </div>
    </div>

    <div class="modal" id="imgModal">
        <div class="box" style="padding:10px; background:transparent; box-shadow:none;">
            <img id="finalImg" style="width:100%; border-radius:10px; margin-bottom:10px;">
            <button class="f-btn b-save" style="width:100%" onclick="closeModal('imgModal')">å…³é—­</button>
        </div>
    </div>

    <script>
        /* --- ç³»ç»Ÿæ ¸å¿ƒé€»è¾‘ --- */
        const DB_KEY = 'billiards_ult_v4';
        
        // éŸ³æ•ˆå¼•æ“ (æ‰¾å›çš„åŠŸèƒ½)
        const SFX = {
            ctx: null,
            init: function() {
                if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            play: function(type) {
                if(!this.ctx) this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain); gain.connect(this.ctx.destination);
                
                const now = this.ctx.currentTime;
                if(type === 'win') {
                    osc.frequency.setValueAtTime(523, now); // C5
                    osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                    osc.start(); osc.stop(now + 0.3);
                } else if (type === 'foul') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
                    osc.start(); osc.stop(now + 0.2);
                }
            }
        };

        // é»˜è®¤é…ç½®
        const defaultRules = {
            normal: { w: 4, label: 'æ™®èƒœ' },
            small: { w: 7, label: 'å°é‡‘' },
            big: { w: 20, label: 'å¤§é‡‘' },
            gold9: { w: 8, label: 'é»„é‡‘9' },
            foul: { l: 1, label: 'çŠ¯è§„' }
        };

        let state = {
            gameType: 'cn8', // 'cn8' æˆ– 'chase'
            mode: 2, // ç©å®¶äººæ•°
            players: [],
            round: 0,
            timer: 0,
            isRunning: false,
            history: [],
            logs: [],
            rules: JSON.parse(JSON.stringify(defaultRules))
        };
        let timerInt;

        // åˆå§‹åŒ–
        (function init() {
            const saved = localStorage.getItem(DB_KEY);
            if (saved) {
                try {
                    state = { ...state, ...JSON.parse(saved) };
                    // å…¼å®¹æ€§æ£€æŸ¥
                    if(!state.rules) state.rules = JSON.parse(JSON.stringify(defaultRules));
                    renderGame();
                } catch(e) {}
            } else {
                openWizard(false);
            }
            if(state.isRunning) startTimer();
            else updateTimerUI();
        })();

        function save() { localStorage.setItem(DB_KEY, JSON.stringify(state)); }

        /* --- æ¸¸æˆæ“ä½œé€»è¾‘ --- */
        
        // 1. ä¸­å¼å…«çƒé€»è¾‘ (ç®€å• +1)
        function handleCn8(idx) {
            pushHistory();
            SFX.play('win');
            state.players[idx].score++;
            state.round++;
            addLog(`${state.players[idx].name} +1`);
            renderGame();
            save();
            if(!state.isRunning) toggleTimer();
        }

        // 2. è¿½åˆ†é€»è¾‘ (è§„åˆ™å¼•æ“)
        function handleChase(idx, type) {
            pushHistory();
            const p = state.players;
            const cur = p[idx];
            const next = p[(idx + 1) % p.length];
            const prev = p[(idx - 1 + p.length) % p.length];
            const is3 = state.mode === 3;
            
            let txt = '';
            
            if (type === 'foul') {
                SFX.play('foul');
                const val = state.rules.foul.l;
                cur.score -= val;
                if(state.gameType === 'chase' && state.mode === 2) next.score += val; // 2äººå±€çŠ¯è§„ç»™å¯¹æ–¹åŠ åˆ†
                else if(is3) prev.score += val; // 3äººå±€ç»™ä¸Šå®¶
                txt = `çŠ¯è§„ -${val}`;
            } else if (type === 'black') { // é»‘é‡‘ç‰¹æ®Šé€»è¾‘
                SFX.play('foul'); // ç±»ä¼¼çŠ¯è§„çš„æç¤ºéŸ³
                if(is3) {
                    cur.score -= 5; next.score += 4; prev.score += 1;
                    // é»‘é‡‘æ¢ä½ï¼šé»‘é‡‘è€…(è¾“å®¶)å»ä¸­é—´ï¼Œä¸‹å®¶å˜åº„
                    const winner = next; const loser = cur; const tail = prev;
                    state.players = [winner, loser, tail];
                } else {
                    cur.score -= 5; next.score += 5;
                }
                txt = 'é»‘é‡‘ -5';
            } else {
                // æ™®èƒœ/å¤§é‡‘/å°é‡‘
                SFX.play('win');
                let val = state.rules[type]?.w || 0;
                if (type === 'normal') val = state.rules.normal.w; // 4
                
                if (is3) {
                    if (type === 'big') {
                        cur.score += 20; next.score -= 10; prev.score -= 10;
                    } else if (type === 'gold9') {
                        cur.score += 8; next.score -= 4; prev.score -= 4;
                    } else if (type === 'small') {
                        cur.score += 7; prev.score -= 7; // å°é‡‘åªåƒä¸Šå®¶
                    } else { // æ™®èƒœ
                        cur.score += 4; prev.score -= 4;
                    }
                    // èµ¢å®¶ååº„
                    if(type !== 'gold9') { // é»„é‡‘9ä¸æ¢ä½
                        const winner = cur; 
                        const p1 = state.players[(idx - 1 + 3) % 3];
                        const p2 = state.players[(idx + 1) % 3];
                        state.players = [winner, p1, p2];
                    }
                } else { // 2äºº
                    cur.score += val; next.score -= val;
                    if(val > 0) [state.players[0], state.players[1]] = [state.players[1], state.players[0]]; // èµ¢å®¶æ¢ä½
                }
                txt = `${state.rules[type]?.label || 'æ™®èƒœ'} +${val}`;
            }

            state.round++;
            addLog(`${cur.name} ${txt}`);
            renderGame();
            save();
            if(!state.isRunning) toggleTimer();
        }

        function pushHistory() {
            if(state.history.length > 10) state.history.shift();
            state.history.push(JSON.parse(JSON.stringify({
                p: state.players, r: state.round, l: state.logs
            })));
        }

        function undo() {
            if(!state.history.length) return alert('æ²¡æ³•å†æ’¤äº†');
            const h = state.history.pop();
            state.players = h.p; state.round = h.r; state.logs = h.l;
            renderGame(); save();
        }

        function addLog(msg) {
            state.logs.unshift({t: msg, time: new Date().toLocaleTimeString('zh-CN',{hour12:false, hour:'2-digit',minute:'2-digit'})});
            if(state.logs.length > 20) state.logs.pop();
        }

        /* --- æ¸²æŸ“é€»è¾‘ (Render) --- */
        function renderGame() {
            const con = document.getElementById('gameContainer');
            con.innerHTML = '';
            document.getElementById('roundNum').innerText = state.round;
            
            // æ¸²æŸ“æ—¥å¿—
            const logDiv = document.getElementById('logArea');
            logDiv.innerHTML = state.logs[0] ? `${state.logs[0].time} ${state.logs[0].t}` : 'å‡†å¤‡å¼€å±€';

            if (state.gameType === 'cn8') {
                // --- æ¸²æŸ“ä¸­å¼å…«çƒ (æ—§åŠŸèƒ½å›å½’) ---
                state.players.forEach((p, i) => {
                    const card = document.createElement('div');
                    card.className = `cn8-card ${i===0 ? 'cn8-red' : 'cn8-blue'}`;
                    card.onclick = () => handleCn8(i);
                    card.innerHTML = `
                        <div class="cn8-name">${p.name}</div>
                        <div class="cn8-score">${p.score}</div>
                    `;
                    con.appendChild(card);
                    if(i===0) con.innerHTML += `<div class="cn8-vs">VS</div>`;
                });
            } else {
                // --- æ¸²æŸ“è¿½åˆ† (æ–°åŠŸèƒ½) ---
                state.players.forEach((p, i) => {
                    const isDealer = i === 0;
                    const card = document.createElement('div');
                    card.className = `chase-card ${isDealer?'dealer':''}`;
                    
                    // æŒ‰é’®é…ç½®
                    const btns = `
                        <button class="act-btn" ${!isDealer?'disabled':''} onclick="handleChase(${i}, 'big')"><b class="btn-l">å¤§é‡‘</b><span class="btn-s">+${state.rules.big.w}</span></button>
                        <button class="act-btn" onclick="handleChase(${i}, 'small')"><b class="btn-l">å°é‡‘</b><span class="btn-s">+${state.rules.small.w}</span></button>
                        <button class="act-btn" ${!isDealer?'disabled':''} onclick="handleChase(${i}, 'gold9')"><b class="btn-l">é»„é‡‘9</b><span class="btn-s">+${state.rules.gold9.w}</span></button>
                        <button class="act-btn" onclick="handleChase(${i}, 'black')"><b class="btn-l" style="color:#AF52DE">é»‘é‡‘</b><span class="btn-s">-5</span></button>
                        <button class="act-btn" onclick="handleChase(${i}, 'normal')"><b class="btn-l" style="color:#007AFF">æ™®èƒœ</b><span class="btn-s">+${state.rules.normal.w}</span></button>
                        <button class="act-btn" onclick="handleChase(${i}, 'foul')"><b class="btn-l" style="color:#FF3B30">çŠ¯è§„</b><span class="btn-s">-${state.rules.foul.l}</span></button>
                    `;

                    card.innerHTML = `
                        <div class="c-header">
                            <div style="font-weight:700; font-size:18px;">${isDealer?'ğŸ‘‘ ':''}${p.name}</div>
                            <div class="c-score ${p.score>=0?'score-p':'score-n'}">${p.score>0?'+':''}${p.score}</div>
                        </div>
                        <div class="btn-grid" style="margin-top:10px;">${btns}</div>
                    `;
                    con.appendChild(card);
                });
            }
            
            // æ’è¡Œæ¦œ
            const sorted = [...state.players].sort((a,b)=>b.score-a.score);
            document.getElementById('leaderboard').innerHTML = sorted.map((p,i)=>`${i+1}.${p.name} ${p.score}`).join(' ');
        }

        /* --- è¾…åŠ©åŠŸèƒ½ --- */
        function toggleTimer() {
            state.isRunning = !state.isRunning;
            if(state.isRunning) startTimer();
            else clearInterval(timerInt);
            updateTimerUI();
        }
        function startTimer() {
            clearInterval(timerInt);
            timerInt = setInterval(() => { state.timer++; updateTimerUI(); }, 1000);
        }
        function updateTimerUI() {
            const m = Math.floor(state.timer/60).toString().padStart(2,'0');
            const s = (state.timer%60).toString().padStart(2,'0');
            const el = document.getElementById('timerDisplay');
            el.innerText = `${m}:${s}`;
            el.classList.toggle('paused', !state.isRunning);
        }
        
        // --- å¼¹çª—ä¸å‘å¯¼ ---
        function openWizard(reset) {
            document.getElementById('wizardModal').classList.add('show');
            if(reset) state.history = [];
        }
        function selectWizMode(type, el) {
            document.querySelectorAll('.wiz-opt').forEach(e=>e.classList.remove('selected'));
            el.classList.add('selected');
            state.gameType = type;
            document.getElementById('chaseOpts').style.display = type === 'chase' ? 'block' : 'none';
        }
        function startGame() {
            if(state.gameType === 'chase') {
                const count = document.querySelector('input[name="pCount"]:checked').value;
                state.mode = parseInt(count);
                state.players = Array.from({length:state.mode}, (_,i)=>({name:`ç©å®¶${String.fromCharCode(65+i)}`, score:0}));
            } else {
                state.mode = 2;
                state.players = [{name:'çº¢æ–¹', score:0}, {name:'è“æ–¹', score:0}];
            }
            state.round = 0; state.timer = 0; state.isRunning = false; state.logs = [];
            closeModal('wizardModal');
            renderGame(); save();
            updateTimerUI();
        }
        function resetGame() {
            if(confirm('ç¡®å®šé‡ç½®ï¼Ÿ')) {
                state.players.forEach(p=>p.score=0);
                state.round = 0; state.timer = 0; state.isRunning = false; state.logs = [];
                renderGame(); save(); updateTimerUI();
                closeModal('settingsModal');
            }
        }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }

        // --- è§„åˆ™è®¾ç½® ---
        function openSettings() {
            if(state.gameType === 'cn8') return alert('ä¸­å¼å…«çƒæ¨¡å¼æš‚æ— é«˜çº§è§„åˆ™');
            const div = document.getElementById('ruleInputs');
            div.innerHTML = '';
            Object.keys(state.rules).forEach(k => {
                div.innerHTML += `
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span>${state.rules[k].label}</span>
                        <input type="number" style="width:50px; text-align:center;" value="${state.rules[k].w || state.rules[k].l}" 
                        onchange="state.rules['${k}'].${state.rules[k].w!==undefined?'w':'l'} = parseInt(this.value)">
                    </div>`;
            });
            document.getElementById('settingsModal').classList.add('show');
        }

        // --- æˆ˜æŠ¥ä¸æˆªå›¾ (html2canvas) ---
        function showSummary() {
            document.getElementById('summaryModal').classList.add('show');
            const sorted = [...state.players].sort((a,b)=>b.score-a.score);
            document.getElementById('sumTime').innerText = `æ—¶é•¿: ${document.getElementById('timerDisplay').innerText} | å›åˆ: ${state.round}`;
            
            // åˆ—è¡¨
            document.getElementById('sumList').innerHTML = sorted.map((p,i) => `
                <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;">
                    <span>${i===0?'ğŸ†':(i===1?'ğŸ¥ˆ':'ğŸ¥‰')} <b>${p.name}</b></span>
                    <span style="font-weight:800; color:${p.score>=0?'#34C759':'#FF3B30'}">${p.score>0?'+':''}${p.score}</span>
                </div>
            `).join('');

            // ç»˜åˆ¶ç®€æ˜“èµ°åŠ¿å›¾ (SVG)
            // å³ä½¿æ˜¯ä¸­å…«æ¨¡å¼ï¼Œä¹Ÿæœ‰èµ°åŠ¿å›¾
            renderTrendChart();
        }

        function renderTrendChart() {
            // æ„é€ æ•°æ®
            // å‡è®¾ logs è®°å½•ä¸å¤Ÿå®Œå–„ï¼Œæˆ‘ä»¬è¿™é‡Œç”¨ history åšç®€æ˜“è¿˜åŸï¼Œæˆ–è€…å¦‚æœ history ç©ºäº†å°±åªæ˜¾ç¤ºå½“å‰
            // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬ç®€å•ç”Ÿæˆä¸€æ®µ SVG
            const box = document.getElementById('trendChart');
            if(state.history.length < 2) { box.innerHTML = '<div style="text-align:center; padding-top:60px; opacity:0.5">æ•°æ®ä¸è¶³</div>'; return; }
            
            // æ”¶é›†æ•°æ®ç‚¹
            const dataPoints = state.history.map(h => h.p.map(pl => pl.score));
            dataPoints.push(state.players.map(p => p.score)); // å½“å‰
            
            const len = dataPoints.length;
            const colors = state.gameType==='cn8' ? ['#FF3B30', '#007AFF'] : ['#007AFF', '#FF9500', '#34C759'];
            
            // æ‰¾æœ€å¤§æœ€å°å€¼ä»¥ç¼©æ”¾
            let min = 0, max = 0;
            dataPoints.forEach(dp => dp.forEach(v => { if(v<min) min=v; if(v>max) max=v; }));
            const range = Math.max(10, max-min);

            let svg = `<svg width="100%" height="100%" viewBox="0 0 ${len-1} 100" preserveAspectRatio="none">`;
            // 0çº¿
            const zeroY = 100 - ((0-min)/range * 100);
            svg += `<line x1="0" y1="${zeroY}" x2="${len-1}" y2="${zeroY}" stroke="rgba(255,255,255,0.3)" stroke-width="0.5" stroke-dasharray="2"/>`;

            for(let i=0; i<state.players.length; i++) {
                const points = dataPoints.map((dp, idx) => {
                    const y = 100 - ((dp[i] - min) / range * 100);
                    return `${idx},${y}`;
                }).join(' ');
                svg += `<polyline points="${points}" fill="none" stroke="${colors[i]}" stroke-width="2" />`;
            }
            svg += `</svg>`;
            box.innerHTML = svg;
        }

        function generateImage() {
            const target = document.getElementById('summaryContent');
            // ä¸´æ—¶è°ƒæ•´æ ·å¼ä»¥é€‚åº”æˆªå›¾
            const originalBg = target.style.background;
            target.style.background = '#F2F2F7'; // å¼ºåˆ¶æµ…è‰²åº•ä»¥ä¾¿ä¿å­˜
            target.style.color = '#000';
            
            html2canvas(target, { scale: 2, backgroundColor: '#F2F2F7' }).then(canvas => {
                target.style.background = originalBg; // æ¢å¤
                target.style.color = '';
                
                const imgData = canvas.toDataURL('image/png');
                document.getElementById('finalImg').src = imgData;
                closeModal('summaryModal');
                document.getElementById('imgModal').classList.add('show');
            }).catch(err => {
                alert('ç”Ÿæˆå¤±è´¥: ' + err);
                target.style.background = originalBg;
                target.style.color = '';
            });
        }

        // ç»‘å®š SoundFX ç”¨æˆ·äº¤äº’è§¦å‘ (æµè§ˆå™¨é™åˆ¶)
        document.body.addEventListener('click', () => SFX.init(), { once: true });

    </script>
</body>
</html>
