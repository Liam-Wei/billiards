<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#F2F2F7">
    <title>æ¡Œçƒè¿½åˆ† (Pro Max)</title>
    <style>
        :root {
            --bg-body: #F2F2F7; --bg-card: #FFFFFF;
            --c-primary: #007AFF; --c-gold-s: #FF9500; --c-gold-b: #AF52DE; --c-gold-9: #FFD60A; 
            --c-foul: #FF3B30; --c-let: #FF2D55;      
            --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background-color: var(--bg-body); margin: 0; padding: 0;
            height: 100dvh; width: 100vw;
            overflow: hidden; 
            display: flex; flex-direction: column;
            padding-top: max(10px, var(--safe-top)); padding-bottom: max(10px, var(--safe-bottom));
            box-sizing: border-box; user-select: none; -webkit-user-select: none;
            touch-action: none; 
        }

        /* --- Header --- */
        header {
            flex-shrink: 0; height: 44px; display: grid; grid-template-columns: 80px 1fr 80px; align-items: center;
            padding: 0 16px; z-index: 10;
        }
        .header-left { display: flex; gap: 8px; justify-content: flex-start; }
        .icon-btn {
            background: none; border: none; padding: 6px; color: var(--c-primary); 
            display: flex; align-items: center; cursor: pointer; border-radius: 50%;
        }
        
        /* è®¡æ—¶å™¨æ ·å¼ */
        .timer-container {
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .timer-btn {
            background: none; border: none; padding: 0; color: #333; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .timer-display {
            font-family: "SF Mono", monospace; font-size: 17px; font-weight: 700; color: #333;
            text-align: center; background: #E5E5EA; padding: 4px 12px; border-radius: 6px;
            min-width: 80px;
        }
        .timer-paused { color: #8E8E93; background: #F2F2F7; border: 1px solid #E5E5EA; }

        .header-right { display: flex; justify-content: flex-end; }
        .reset-btn { 
            border: none; background: none; color: var(--c-foul); font-size: 15px; font-weight: 600; 
            cursor: pointer;
        }

        /* --- é¡¶éƒ¨ä¿¡æ¯æ  --- */
        .info-bar {
            flex-shrink: 0; height: 85px; 
            margin: 4px 12px;
            display: grid; 
            grid-template-columns: 1.2fr 0.6fr 1.2fr;
            align-items: center;
            background: white;
            border-radius: 12px;
            padding: 0 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            gap: 4px;
        }

        .logs-area {
            display: flex; flex-direction: column; justify-content: center;
            font-size: 11px; line-height: 1.35; color: #8E8E93; text-align: left; overflow: hidden;
            height: 100%; padding: 4px 0;
        }
        .log-line { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .log-line.latest { color: var(--c-primary); font-weight: 600; font-size: 11.5px; }

        .round-area {
            text-align: center; font-size: 26px; font-weight: 800; color: #333;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            line-height: 1; height: 100%;
        }
        .round-area small { font-size: 10px; font-weight: 500; color: #8E8E93; margin-top: 2px; }

        .leaderboard-area {
            display: flex; flex-direction: column; justify-content: center;
            font-size: 12px; color: #333; gap: 3px;
        }
        .lb-row { display: flex; align-items: center; gap: 4px; }
        .lb-rank { width: 14px; text-align: center; font-size: 12px; }
        .lb-name { font-weight: 600; font-size: 13px; max-width: 50px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #333; }
        .lb-score { font-family: monospace; font-weight: 800; font-size: 14px; margin-left: auto; color: #000; }

        /* --- ä¸»åŒºåŸŸ --- */
        main {
            flex: 1; display: flex; flex-direction: column; justify-content: space-evenly; 
            padding: 2px 12px; overflow: hidden; gap: 6px;
        }

        .player-card {
            background: var(--bg-card); border-radius: 16px; 
            padding: 8px 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            display: flex; flex-direction: column; justify-content: center; transition: all 0.3s;
        }
        
        /* 1. åº„å®¶ (ç¬¬ä¸€å¼ å¡ç‰‡) æ ·å¼ */
        .player-card.is-dealer { 
            border: 1.5px solid rgba(255, 149, 0, 0.3); 
            background: #FFFCF5; /* æš–è‰²èƒŒæ™¯ */
        }
        
        /* 2. è¾“å®¶/é—²å®¶ (ç¬¬äºŒå¼ å¡ç‰‡) æ ·å¼ */
        .player-card.is-loser { 
            border: 1.5px solid rgba(142, 142, 147, 0.3); 
            background: #ECF1F6; /* å†·ç°è“èƒŒæ™¯ */
        }
        
        .card-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .left-info { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .rank-num {
            width: 20px; height: 20px; background: #E5E5EA; color: #666; 
            font-size: 12px; font-weight: 700; border-radius: 5px; 
            display: flex; align-items: center; justify-content: center;
        }
        
        /* çŠ¶æ€å›¾æ ‡åŠ¨ç”» */
        .status-icon { font-size: 16px; margin-left: 4px; animation: popIn 0.3s; display: inline-block; }
        @keyframes popIn { 0%{transform:scale(0);} 80%{transform:scale(1.2);} 100%{transform:scale(1);} }

        .p-name { font-size: 16px; font-weight: 600; color: #333; }
        .p-score { font-size: 28px; font-weight: 800; line-height: 1; font-variant-numeric: tabular-nums; }
        .score-p { color: #34C759; } .score-n { color: #FF3B30; } .score-z { color: #1C1C1E; }

        .btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 2px;}
        .act-btn {
            border: none; border-radius: 9px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; cursor: pointer; padding: 7px 0;
            background: #F2F2F7; position: relative; overflow: hidden;
        }
        .act-btn:active { transform: scale(0.96); }
        .act-btn::after {
            content: ""; position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            background: rgba(0,0,0,0.05); opacity: 0; transition: opacity 0.2s;
        }
        .act-btn:active::after { opacity: 1; }

        .btn-t { font-size: 13px; font-weight: 600; margin-bottom: 0px; white-space: nowrap;}
        .btn-s { font-size: 9px; opacity: 0.7; font-weight: 500; letter-spacing: -0.2px; white-space: nowrap; transform: scale(0.95); }

        .b-norm { background: #E1F0FF; color: var(--c-primary); }
        .b-sgold { background: #FFF3DC; color: var(--c-gold-s); }
        .b-bgold { background: #F3E5F5; color: var(--c-gold-b); }
        .b-gold9 { background: #FFFDE7; color: #9A7D0A; } 
        .b-black { background: #3A3A3C; color: #FFF; }
        .b-foul { background: #FFEEEE; color: var(--c-foul); }
        .b-let { background: #FFF0F5; color: var(--c-let); }

        /* --- Footer --- */
        footer {
            flex-shrink: 0; display: flex; justify-content: space-between;
            padding: 8px 16px; gap: 12px; height: 44px;
        }
        .footer-btn {
            flex: 1; border-radius: 21px; display: flex; align-items: center; justify-content: center; gap: 6px;
            font-size: 14px; font-weight: 600; border: none; cursor: pointer;
        }
        .btn-undo { background: #FFF; color: #555; border: 1px solid #E5E5EA; }
        .btn-save { background: #1C1C1E; color: #FFF; }

        /* Modals */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            z-index: 100; display: none; opacity: 0; transition: opacity 0.25s;
            justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        .center-box {
            background: #FFF; width: 300px; max-width: 90%; border-radius: 18px; 
            padding: 20px; text-align: center; transform: scale(0.9); transition: transform 0.2s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto;
        }
        .modal-overlay.show .center-box { transform: scale(1); }
        .modal-input {
            width: 100%; box-sizing: border-box; padding: 12px; background: #F2F2F7; 
            border: none; border-radius: 12px; margin: 16px 0; text-align: center; font-size: 16px;
        }
        .setting-opt {
            background: #F2F2F7; padding: 10px; border-radius: 10px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .setting-opt.selected { background: #E1F0FF; border: 1px solid var(--c-primary); }

        .btn-confirm { flex:1; padding:12px; border:none; border-radius:12px; background:var(--c-primary); color:#FFF; font-weight:600; transition: all 0.2s; }
        .btn-confirm:disabled { background: #CCC; cursor: not-allowed; opacity: 0.7; }

        /* Summary Receipt Style */
        .receipt-header { border-bottom: 2px dashed #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .res-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 6px; }
        .stat-badge {
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; padding: 3px 2px; border-radius: 4px; 
            font-weight: 600; margin: 0; white-space: nowrap;
        }
        .sb-gold { background: #F3E5F5; color: var(--c-gold-b); }
        .sb-win { background: #E1F0FF; color: var(--c-primary); }
        .sb-foul { background: #FFEEEE; color: var(--c-foul); }
        .result-row { display: flex; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid #F2F2F7; }

        #toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); color: white; padding: 16px 24px; border-radius: 12px;
            font-size: 15px; font-weight: 600; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            z-index: 999; text-align: center; line-height: 1.4; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div id="toast">å·²ä¿å­˜</div>

    <header>
        <div class="header-left">
            <button class="icon-btn" onclick="openSettings()">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <button class="icon-btn" onclick="openLogModal()">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
        </div>

        <div class="timer-container">
            <button class="timer-btn" id="timerControlBtn" onclick="toggleTimer()">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <div class="timer-display timer-paused" id="gameTimer">00:00:00</div>
        </div>

        <div class="header-right">
            <button class="reset-btn" onclick="resetGame()">é‡ç½®</button>
        </div>
    </header>

    <div class="info-bar">
        <div class="logs-area" id="logsArea">
            <div style="opacity:0.3">ç­‰å¾…å¼€å±€...</div>
        </div>
        <div class="round-area" id="roundBigDisplay">0<small>å›åˆ</small></div>
        <div class="leaderboard-area" id="leaderboardArea"></div> 
    </div>

    <main id="container"></main>

    <footer>
        <button class="footer-btn btn-undo" onclick="undo()">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" stroke-linecap="round" stroke-linejoin="round"/></svg>æ’¤é”€
        </button>
        <button class="footer-btn btn-save" onclick="handleSettleNow(); return false;">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"/></svg>ç»“ç®—/åˆ†äº«
        </button>
    </footer>

    <div class="modal-overlay" id="confirmModal" style="z-index: 150;">
        <div class="center-box">
            <div id="confirmTitle" style="font-size:18px; font-weight:800; margin-bottom:12px;">æ“ä½œç¡®è®¤</div>
            <div id="confirmDesc" style="font-size:15px; color:#333; margin-bottom:8px; font-weight:600;"></div>
            <div id="confirmDetail" style="font-size:13px; color:#666; margin-bottom:20px; background:#F2F2F7; padding:10px; border-radius:8px;"></div>
            <div style="display:flex; gap:10px;">
                <button style="flex:1; padding:12px; border:none; border-radius:12px; background:#F2F2F7; color:#8E8E93; font-weight:600;" onclick="closeConfirmModal()">å–æ¶ˆ</button>
                <button id="realConfirmBtn" class="btn-confirm" onclick="confirmPendingAction()" disabled>ç¡®å®š (0.5s)</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="logModal">
        <div class="center-box" style="width:320px;">
            <div style="font-size:18px; font-weight:800; margin-bottom:12px;">æ“ä½œæ—¥å¿—</div>
            <div id="logContent" style="max-height: 300px; overflow-y: auto; margin-bottom:16px;"></div>
            <button style="width:100%; padding:12px; background:#F2F2F7; color:#333; border:none; border-radius:12px; font-weight:600;" onclick="closeLogModal()">å…³é—­</button>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="center-box">
            <div style="font-size:16px; font-weight:700; margin-bottom:12px;">è®¾ç½®</div>
            
            <div style="text-align:left; font-size:12px; color:#8E8E93; margin-bottom:6px;">äººæ•°æ¨¡å¼</div>
            <div style="display:flex; background:#E5E5EA; border-radius:10px; padding:2px; margin-bottom:16px;">
                <button class="toggle-btn" id="mode2" onclick="switchMode(2)" style="flex:1; padding:8px; border:none; background:transparent; border-radius:8px; font-weight:600; color:#888;">2äºº</button>
                <button class="toggle-btn active" id="mode3" onclick="switchMode(3)" style="flex:1; padding:8px; border:none; background:#FFF; border-radius:8px; font-weight:600; box-shadow:0 1px 3px rgba(0,0,0,0.1);">3äºº</button>
            </div>

            <div style="text-align:left; font-size:12px; color:#8E8E93; margin-bottom:6px;">2äººå±€è®¡åˆ†æœºåˆ¶</div>
            <div class="setting-opt selected" id="optTransfer" onclick="setScoreMode('transfer')">
                <div><span style="font-weight:600;font-size:14px;">ç»™ä»˜åˆ¶</span><div style="font-size:10px;color:#888">èµ¢+10 è¾“-10</div></div>
                <div style="color:var(--c-primary); font-weight:bold;">âœ“</div>
            </div>
            <div class="setting-opt" id="optRace" onclick="setScoreMode('race')">
                <div><span style="font-weight:600;font-size:14px;">æŠ¢åˆ†åˆ¶</span><div style="font-size:10px;color:#888">èµ¢+10 è¾“0</div></div>
                <div style="color:var(--c-primary); font-weight:bold; display:none;">âœ“</div>
            </div>
            <div class="modal-btns" style="margin-top:16px;">
                <button style="background:var(--c-primary); color:#FFF; flex:1; padding:12px; border:none; border-radius:12px; font-size:15px; font-weight:600; width:100%" onclick="closeSettings()">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="nameModal">
        <div class="center-box">
            <div style="font-size:16px; font-weight:700;">ä¿®æ”¹åå­—</div>
            <input type="text" class="modal-input" id="nameInput" placeholder="è¾“å…¥æ–°åå­—" maxlength="8">
            <div style="display:flex; gap:10px;">
                <button style="flex:1; padding:10px; border:none; border-radius:12px; background:#F2F2F7; color:#8E8E93; font-weight:600;" onclick="closeNameModal()">å–æ¶ˆ</button>
                <button style="flex:1; padding:10px; border:none; border-radius:12px; background:var(--c-primary); color:#FFF; font-weight:600;" onclick="saveName()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="summaryModal">
        <div class="center-box" style="width:340px;">
            <div class="receipt-header">
                <div id="summaryTitle" style="font-size:20px; font-weight:800;">æˆ˜å±€ç»“ç®—</div>
                <div id="summaryTime" style="font-size:12px; color:#8E8E93; margin-top:4px;"></div>
            </div>
            <div id="summaryContent" style="max-height: 50vh; overflow-y:auto;"></div>
            <div style="display:flex; gap:10px; margin-top:16px;">
                 <button style="flex:1; padding:12px; background:#F2F2F7; color:#333; border:none; border-radius:12px; font-weight:600;" onclick="closeSummary()">å…³é—­</button>
                 <button style="flex:1; padding:12px; background:var(--c-primary); color:#FFF; border:none; border-radius:12px; font-weight:600;" onclick="copyReport()">å¤åˆ¶æˆ˜æŠ¥</button>
            </div>
        </div>
    </div>

    <script>
        // --- éŸ³æ•ˆåˆæˆå¼•æ“ ---
        const SoundFX = {
            ctx: null,
            init: function() {
                if (!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) this.ctx = new AudioContext();
                }
                if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume();
            },
            playTone: function(freq, type, duration) {
                if (!this.ctx) this.init();
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            click: function() { this.playTone(800, 'sine', 0.1); },
            win: function() { 
                setTimeout(()=>this.playTone(523.25, 'triangle', 0.3), 0); // C5
                setTimeout(()=>this.playTone(659.25, 'triangle', 0.3), 100); // E5
                setTimeout(()=>this.playTone(783.99, 'triangle', 0.4), 200); // G5
            },
            foul: function() {
                this.playTone(150, 'sawtooth', 0.3);
                setTimeout(()=>this.playTone(100, 'sawtooth', 0.3), 150);
            }
        };

        // --- æ ¸å¿ƒé€»è¾‘ ---
        const DB_KEY = 'billiards_pro_max_v2';
        let pendingAction = null;
        let currentEditIndex = -1;
        let timerInterval = null;

        const emptyStats = () => ({ bigGold: 0, smallGold: 0, gold9: 0, normal: 0, blackGold: 0, fouls: 0 });
        
        let state = {
            mode: 3,
            round: 0, 
            timerSeconds: 0,
            timerRunning: false,
            scoreMode: 'transfer', 
            players: [
                { id: 0, name: 'ç©å®¶ A', score: 0, stats: emptyStats() },
                { id: 1, name: 'ç©å®¶ B', score: 0, stats: emptyStats() },
                { id: 2, name: 'ç©å®¶ C', score: 0, stats: emptyStats() }
            ],
            history: [],
            logs: []
        };

        // åˆå§‹åŒ–
        (function init() {
            const saved = localStorage.getItem(DB_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed.startTime !== undefined && parsed.timerSeconds === undefined) {
                         parsed.timerSeconds = 0; parsed.timerRunning = false;
                    }
                    state = parsed;
                } catch(e) { console.error('Resetting data due to error'); }
            }
            
            updateTimerDisplay();
            if(state.timerRunning) startTimerInterval();
            else updateTimerBtnUI(false);

            updateUI();
            
            document.addEventListener('click', async () => {
                SoundFX.init(); 
                try { if ('wakeLock' in navigator) await navigator.wakeLock.request('screen'); } catch(e){}
            }, {once:true});
        })();

        function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(state)); }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = 1; t.style.top = '50%';
            setTimeout(() => t.style.opacity = 0, 2000);
        }

        // --- è®¡æ—¶å™¨é€»è¾‘ ---
        function toggleTimer() {
            SoundFX.click();
            state.timerRunning = !state.timerRunning;
            if (state.timerRunning) {
                startTimerInterval();
            } else {
                clearInterval(timerInterval);
                updateTimerBtnUI(false);
            }
            saveData();
        }

        function startTimerInterval() {
            updateTimerBtnUI(true);
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                state.timerSeconds++;
                updateTimerDisplay();
                if(state.timerSeconds % 10 === 0) saveData(); 
            }, 1000);
        }

        function updateTimerBtnUI(isRunning) {
            const btn = document.getElementById('timerControlBtn');
            const display = document.getElementById('gameTimer');
            if (isRunning) {
                btn.innerHTML = '<svg width="24" height="24" fill="#FF3B30" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>'; // Pause
                display.classList.remove('timer-paused');
                display.style.background = '#E5E5EA';
            } else {
                btn.innerHTML = '<svg width="24" height="24" fill="#34C759" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>'; // Play
                display.classList.add('timer-paused');
            }
        }

        function updateTimerDisplay() {
            const total = state.timerSeconds || 0;
            const h = Math.floor(total / 3600).toString().padStart(2, '0');
            const m = Math.floor((total % 3600) / 60).toString().padStart(2, '0');
            const s = (total % 60).toString().padStart(2, '0');
            document.getElementById('gameTimer').innerText = `${h}:${m}:${s}`;
        }

        const actionNames = {
            'normal': 'æ™®èƒœ', 'smallGold': 'å°é‡‘', 'bigGold': 'å¤§é‡‘', 'gold9': 'é»„é‡‘9',
            'blackGold': 'é»‘é‡‘', 'foul': 'çŠ¯è§„', 'letFoul': 'è®©æ†', 'openFoul': 'å¼€çƒçŠ¯è§„'
        };

        window.handleAction = function(idx, type) {
            SoundFX.click();
            const pName = state.players[idx].name;
            const aName = actionNames[type];
            const diffText = calculateDiffText(idx, type);
            pendingAction = { idx, type, pName, aName, diffText };
            
            document.getElementById('confirmDesc').innerText = `ç¡®è®¤ ${pName} ${aName}ï¼Ÿ`;
            document.getElementById('confirmDetail').innerText = diffText;
            
            const btn = document.getElementById('realConfirmBtn');
            btn.disabled = true;
            btn.innerText = "ç¡®å®š (0.5s)";
            btn.style.opacity = 0.6;
            
            const modal = document.getElementById('confirmModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);

            let cd = 5;
            const cdTimer = setInterval(() => {
                cd--;
                if(cd <= 0) {
                    clearInterval(cdTimer);
                    btn.disabled = false;
                    btn.innerText = "ç¡®å®š";
                    btn.style.opacity = 1;
                } else {
                    btn.innerText = `ç¡®å®š (0.${cd}s)`;
                }
            }, 100);
        };

        function calculateDiffText(idx, type) {
            const total = state.mode;
            const prev = (idx - 1 + total) % total;
            const next = (idx + 1) % total;
            const p = state.players;
            let changes = [];
            if (total === 3) {
                switch (type) {
                    case 'normal': changes = [{i:idx, v:4}, {i:prev, v:-4}]; break;
                    case 'smallGold': changes = [{i:idx, v:7}, {i:prev, v:-7}]; break;
                    case 'bigGold': changes = [{i:idx, v:20}, {i:prev, v:-10}, {i:next, v:-10}]; break;
                    case 'gold9': changes = [{i:idx, v:8}, {i:prev, v:-4}, {i:next, v:-4}]; break;
                    case 'foul': changes = [{i:idx, v:-1}, {i:prev, v:1}]; break;
                    case 'letFoul': changes = [{i:idx, v:-1}, {i:next, v:1}]; break;
                    case 'openFoul': changes = [{i:idx, v:-1}, {i:next, v:1}]; break;
                    case 'blackGold': changes = [{i:idx, v:-5}, {i:prev, v:1}, {i:next, v:4}]; break;
                }
            } else {
                const isRace = state.scoreMode === 'race';
                const opp = next;
                let vWin = 0;
                switch (type) {
                    case 'normal': vWin=4; break;
                    case 'smallGold': vWin=7; break;
                    case 'bigGold': vWin=10; break;
                    case 'gold9': vWin=4; break;
                    case 'blackGold': vWin=-5; break;
                    default: vWin=-1; break;
                }
                if (['foul','letFoul','openFoul'].includes(type)) {
                    changes = [{i:idx, v:-1}]; if(!isRace) changes.push({i:opp, v:1});
                } else if (type === 'blackGold') {
                    changes = [{i:idx, v:-5}]; if(!isRace) changes.push({i:opp, v:5});
                } else {
                    changes = [{i:idx, v:vWin}]; if(!isRace) changes.push({i:opp, v:-vWin});
                }
            }
            return changes.map(c => `${p[c.i].name} ${c.v > 0 ? '+' : ''}${c.v}`).join('ï¼Œ');
        }

        window.closeConfirmModal = function() {
            document.getElementById('confirmModal').classList.remove('show');
            setTimeout(() => document.getElementById('confirmModal').style.display = 'none', 200);
            pendingAction = null;
        };

        window.confirmPendingAction = function() {
            if (!pendingAction) return;
            const { idx, type, pName, aName, diffText } = pendingAction;
            closeConfirmModal();

            if(['foul','letFoul','openFoul','blackGold'].includes(type)) SoundFX.foul();
            else SoundFX.win();

            if (state.history.length > 20) state.history.shift();
            state.history.push(JSON.parse(JSON.stringify({
                mode: state.mode, round: state.round, scoreMode: state.scoreMode, 
                players: state.players, logs: state.logs, timerSeconds: state.timerSeconds
            })));

            const isGameEnd = ['normal','smallGold','bigGold','gold9','blackGold'].includes(type);
            if (isGameEnd) state.round++;

            if(!state.timerRunning) toggleTimer();

            const total = state.mode;
            const prev = (idx - 1 + total) % total;
            const next = (idx + 1) % total;
            let ps = state.players;

            if (!ps[idx].stats) ps[idx].stats = emptyStats();
            
            if (type === 'normal') ps[idx].stats.normal++;
            else if (type === 'smallGold') ps[idx].stats.smallGold++;
            else if (type === 'bigGold') ps[idx].stats.bigGold++;
            else if (type === 'gold9') ps[idx].stats.gold9++;
            else if (type === 'blackGold') ps[idx].stats.blackGold++;
            else if (['foul', 'letFoul', 'openFoul'].includes(type)) ps[idx].stats.fouls++;

            if (total === 3) {
                switch (type) {
                    case 'normal': ps[idx].score += 4; ps[prev].score -= 4; break;
                    case 'smallGold': ps[idx].score += 7; ps[prev].score -= 7; break;
                    case 'bigGold': ps[idx].score += 20; ps[prev].score -= 10; ps[next].score -= 10; break;
                    case 'gold9': ps[idx].score += 8; ps[prev].score -= 4; ps[next].score -= 4; break;
                    case 'foul': ps[idx].score -= 1; ps[prev].score += 1; break;
                    case 'letFoul': ps[idx].score -= 1; ps[next].score += 1; break;
                    case 'openFoul': ps[idx].score -= 1; ps[next].score += 1; break;
                    case 'blackGold': ps[idx].score -= 5; ps[prev].score += 1; ps[next].score += 4; break;
                }
            } else if (total === 2) {
                const isRace = state.scoreMode === 'race'; 
                const opp = next;
                const scores = { normal: 4, smallGold: 7, bigGold: 10, gold9: 4 };
                if (['foul','letFoul','openFoul'].includes(type)) {
                    ps[idx].score -= 1; if(!isRace) ps[opp].score += 1;
                } else if (type === 'blackGold') {
                    ps[idx].score -= 5; if(!isRace) ps[opp].score += 5;
                } else {
                    const sc = scores[type];
                    ps[idx].score += sc; if(!isRace) ps[opp].score -= sc;
                }
            }

            if (!state.logs) state.logs = [];
            state.logs.unshift({
                round: isGameEnd ? state.round : '-',
                text: `${pName} ${aName}`,
                detail: diffText,
                time: new Date().toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'})
            });
            if (state.logs.length > 50) state.logs.pop();

            if (isGameEnd) rotateWinner(idx, type);
            
            saveData();
            updateUI();
        };

        function rotateWinner(winnerIdx, type) {
            if (state.mode === 3) {
                if (type === 'blackGold') {
                    const total = 3;
                    const p = state.players;
                    const current = p[winnerIdx]; 
                    const next = p[(winnerIdx + 1) % total]; 
                    const prev = p[(winnerIdx - 1 + total) % total]; 
                    state.players = [next, prev, current]; 
                } else {
                    if (winnerIdx !== 0) {
                        const p = state.players;
                        const winner = p[winnerIdx];
                        const loser = p[0]; 
                        const other = p.find((_,i) => i!==0 && i!==winnerIdx);
                        state.players = [winner, other, loser];
                    }
                }
            } else if (state.mode === 2) {
                if (winnerIdx !== 0) [state.players[0], state.players[1]] = [state.players[1], state.players[0]];
            }
        }

        window.openLogModal = function() {
            SoundFX.click();
            const el = document.getElementById('logContent');
            if (!state.logs || state.logs.length === 0) {
                el.innerHTML = '<div style="color:#ccc; font-size:13px; text-align:center; padding:20px;">æš‚æ— è®°å½•</div>';
            } else {
                el.innerHTML = state.logs.map(l => `
                    <div class="log-item" style="border-bottom:1px solid #eee; padding:8px 0;">
                        <div style="font-size:14px; color:#333;"><span style="color:#aaa; font-family:monospace; margin-right:4px;">R${l.round}</span> ${l.text} <span style="float:right; color:#ccc; font-size:11px;">${l.time}</span></div>
                        <div style="font-size:11px; color:#888; margin-top:2px;">${l.detail}</div>
                    </div>
                `).join('');
            }
            const modal = document.getElementById('logModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        };
        window.closeLogModal = function() {
            SoundFX.click();
            const modal = document.getElementById('logModal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 200);
        };

        window.undo = function() {
            SoundFX.click();
            if (!state.history || state.history.length === 0) return showToast("æ— æ“ä½œå¯æ’¤é”€");
            const previous = state.history.pop();
            state.mode = previous.mode;
            state.round = previous.round;
            state.scoreMode = previous.scoreMode;
            state.players = previous.players;
            state.logs = previous.logs || [];
            saveData();
            updateUI();
            showToast("â†º å·²æ’¤é”€ä¸€æ­¥"); 
        };

        window.resetGame = function() {
            SoundFX.click();
            if (confirm("é‡ç½®æ¯”èµ›ï¼Ÿæ‰€æœ‰æ•°æ®å°†æ¸…ç©ºã€‚")) {
                state.round = 0;
                state.history = []; 
                state.logs = [];
                state.timerSeconds = 0;
                state.timerRunning = false;
                clearInterval(timerInterval);
                updateTimerBtnUI(false);
                updateTimerDisplay();
                
                state.players.forEach(p => { p.score = 0; p.stats = emptyStats(); }); 
                saveData();
                updateUI();
            }
        };

        window.switchMode = function(n) {
            SoundFX.click();
            if (state.mode === n) return;
            if (!confirm('åˆ‡æ¢äººæ•°ä¼šé‡ç½®æ¯”åˆ†ï¼Œç¡®å®šå—?')) return;
            state.mode = n;
            state.round = 0; 
            state.timerSeconds = 0;
            state.timerRunning = false;
            clearInterval(timerInterval);
            updateTimerBtnUI(false);
            updateTimerDisplay();

            state.history = []; state.logs = []; state.players = [];
            const defs = ['ç©å®¶ A', 'ç©å®¶ B', 'ç©å®¶ C'];
            for(let i=0; i<n; i++) state.players.push({ id: i, name: defs[i], score: 0, stats: emptyStats() });
            
            document.getElementById('mode2').className = n===2 ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('mode2').style.background = n===2 ? '#FFF' : 'transparent';
            document.getElementById('mode3').className = n===3 ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('mode3').style.background = n===3 ? '#FFF' : 'transparent';

            saveData();
            updateUI();
        };

        window.saveName = function() { 
            const val = document.getElementById('nameInput').value.trim(); 
            if(val) { state.players[currentEditIndex].name = val; saveData(); updateUI(); } 
            closeNameModal(); 
        };
        window.setScoreMode = function(mode) { SoundFX.click(); state.scoreMode = mode; saveData(); updateUI(); openSettings(); };

        function updateUI() {
            document.getElementById('roundBigDisplay').innerHTML = `${state.round}<small>å›åˆ</small>`;
            
            const logBox = document.getElementById('logsArea');
            const recentLogs = state.logs ? state.logs.slice(0, 5) : [];
            if (recentLogs.length === 0) {
                logBox.innerHTML = '<div style="opacity:0.3; text-align:center; margin-top:10px;">ç­‰å¾…å¼€å±€...</div>';
            } else {
                logBox.innerHTML = recentLogs.map((l, idx) => `
                    <div class="log-line ${idx === 0 ? 'latest' : ''}" style="opacity:${1 - idx*0.15}">
                       <span style="font-family:monospace; margin-right:2px; font-size:10px;">${l.time}</span> ${l.text}
                    </div>
                `).join('');
            }

            const lbBox = document.getElementById('leaderboardArea');
            const sortedP = [...state.players].sort((a,b) => b.score - a.score);
            const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
            lbBox.innerHTML = sortedP.map((p, i) => {
                if(i > 2) return '';
                return `
                <div class="lb-row">
                    <div class="lb-rank">${medals[i]||(i+1)}</div>
                    <div class="lb-name">${p.name}</div>
                    <div class="lb-score">${p.score}</div>
                </div>`;
            }).join('');

            const box = document.getElementById('container');
            box.innerHTML = '';
            let txtBig = 'é€šåƒ 20'; let txtG9 = 'é€šåƒ 8'; let txtBlack = 'ä¸Š+1 ä¸‹+4';
            if (state.mode === 2) {
                if (state.scoreMode === 'transfer') { txtBig = 'è‡ª+10 ä»–-10'; txtG9 = 'è‡ª+4 ä»–-4'; txtBlack = 'è‡ª-5 ä»–+5'; } 
                else { txtBig = 'è‡ª+10'; txtG9 = 'è‡ª+4'; txtBlack = 'è‡ª-5'; }
            }

            state.players.forEach((p, i) => {
                let sc = p.score > 0 ? 'score-p' : (p.score < 0 ? 'score-n' : 'score-z');
                let sig = p.score > 0 ? '+' : '';
                
                const isDealer = (i === 0);
                const isLoser = (i === 1);
                
                let cardClass = 'player-card';
                let statusIcon = '';
                
                if (isDealer) {
                    cardClass += ' is-dealer';
                    statusIcon = '<span class="status-icon">ğŸ±</span>';
                } else if (isLoser) {
                    cardClass += ' is-loser';
                    statusIcon = '<span class="status-icon">ğŸ˜­</span>'; // ä½¿ç”¨ç™½çƒä½œä¸ºè¾“å®¶/æ‘†çƒæ–¹çš„æ ‡å¿—
                }
                
                const el = document.createElement('div');
                el.className = cardClass;
                el.innerHTML = `
                    <div class="card-header-row">
                        <div class="left-info" onclick="openNameModal(${i})">
                            <div class="rank-num">${i + 1}</div>
                            <div class="p-name">${p.name} ${statusIcon}</div>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="#CCC"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/></svg>
                        </div>
                        <div class="p-score ${sc}">${sig}${p.score}</div>
                    </div>
                    <div class="btn-grid">
                        <button class="act-btn b-bgold" onclick="handleAction(${i}, 'bigGold')"><span class="btn-t">å¤§é‡‘</span><span class="btn-s">${txtBig}</span></button>
                        <button class="act-btn b-sgold" onclick="handleAction(${i}, 'smallGold')"><span class="btn-t">å°é‡‘</span><span class="btn-s">è‡ª+7 ä¸Š-7</span></button>
                        <button class="act-btn b-gold9" onclick="handleAction(${i}, 'gold9')"><span class="btn-t">é»„é‡‘9</span><span class="btn-s">${txtG9}</span></button>
                        <button class="act-btn b-black" onclick="handleAction(${i}, 'blackGold')"><span class="btn-t">é»‘é‡‘</span><span class="btn-s">${txtBlack}</span></button>
                        <button class="act-btn b-norm" onclick="handleAction(${i}, 'normal')"><span class="btn-t">æ™®èƒœ</span><span class="btn-s">è‡ª+4 ä¸Š-4</span></button>
                        <button class="act-btn b-foul" onclick="handleAction(${i}, 'foul')"><span class="btn-t">çŠ¯è§„</span><span class="btn-s">ç»™ä¸Šå®¶ 1</span></button>
                        <button class="act-btn b-let" onclick="handleAction(${i}, 'letFoul')"><span class="btn-t">è®©æ†</span><span class="btn-s">ç»™ä¸‹å®¶ 1</span></button>
                        <button class="act-btn b-foul" style="background:#FFEAEA" onclick="handleAction(${i}, 'openFoul')"><span class="btn-t">å¼€çƒçŠ¯è§„</span><span class="btn-s">ç»™ä¸‹å®¶ 1</span></button>
                    </div>
                `;
                box.appendChild(el);
            });
        }

        window.openSettings = function() { SoundFX.click(); document.getElementById('settingsModal').style.display = 'flex'; setTimeout(() => document.getElementById('settingsModal').classList.add('show'), 10); };
        window.closeSettings = function() { SoundFX.click(); document.getElementById('settingsModal').classList.remove('show'); setTimeout(() => document.getElementById('settingsModal').style.display = 'none', 200); };
        window.openNameModal = function(i) { SoundFX.click(); currentEditIndex = i; document.getElementById('nameInput').value = ''; document.getElementById('nameModal').style.display = 'flex'; setTimeout(() => document.getElementById('nameModal').classList.add('show'), 10); setTimeout(() => document.getElementById('nameInput').focus(), 50); };
        window.closeNameModal = function() { document.getElementById('nameModal').classList.remove('show'); setTimeout(() => { document.getElementById('nameModal').style.display = 'none'; document.getElementById('nameInput').blur(); }, 200); };
        window.handleSettleNow = function() { SoundFX.click(); showSummary(); };
        window.closeSummary = function() { SoundFX.click(); document.getElementById('summaryModal').classList.remove('show'); setTimeout(() => document.getElementById('summaryModal').style.display = 'none', 300); };

        function showSummary() {
            document.getElementById('summaryTitle').innerText = `æˆ˜å±€ç»“ç®—`;
            document.getElementById('summaryTime').innerText = `å…±${state.round}å›åˆ Â· æ—¶é•¿${document.getElementById('gameTimer').innerText}`;
            const sortedPlayers = [...state.players].sort((a, b) => b.score - a.score);
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            let html = '';
            sortedPlayers.forEach((p, idx) => {
                const medal = medals[idx] || (idx + 1);
                const color = p.score > 0 ? '#34C759' : (p.score < 0 ? '#FF3B30' : '#000');
                const sign = p.score > 0 ? '+' : '';
                const st = p.stats || emptyStats();
                const totalWins = (st.bigGold||0) + (st.smallGold||0) + (st.gold9||0) + (st.normal||0);
                
                html += `
                    <div class="result-row">
                        <div class="res-rank">${medal}</div>
                        <div style="flex:1;">
                            <div style="display:flex; justify-content:space-between;">
                                <span class="res-name">${p.name}</span>
                                <span class="res-score" style="color:${color}">${sign}${p.score}</span>
                            </div>
                            <div class="res-stats-grid">
                                <span class="stat-badge sb-win">èƒœå±€:${totalWins}</span>
                                <span class="stat-badge sb-gold">å¤§é‡‘:${st.bigGold||0}</span>
                                <span class="stat-badge sb-gold">å°é‡‘:${st.smallGold||0}</span>
                                <span class="stat-badge sb-gold">é»„é‡‘9:${st.gold9||0}</span>
                                <span class="stat-badge" style="background:#333;color:#fff">é»‘é‡‘:${st.blackGold||0}</span>
                                <span class="stat-badge sb-foul">çŠ¯è§„:${st.fouls||0}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('summaryContent').innerHTML = html;
            const modal = document.getElementById('summaryModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        window.copyReport = function() {
            SoundFX.click();
            const time = document.getElementById('gameTimer').innerText;
            let text = `ğŸ± æ¡Œçƒè¿½åˆ†æˆ˜æŠ¥\nâ±ï¸ æ—¶é•¿: ${time} | å›åˆ: ${state.round}\n------------------\n`;
            
            const sortedPlayers = [...state.players].sort((a, b) => b.score - a.score);
            sortedPlayers.forEach((p, i) => {
                const sign = p.score > 0 ? '+' : '';
                const rank = i===0?'ğŸ¥‡':(i===1?'ğŸ¥ˆ':'ğŸ¥‰');
                text += `${rank} ${p.name}: ${sign}${p.score}\n`;
            });
            text += `------------------\n`;
            
            text += `ğŸ“Š è¯¦ç»†æ•°æ®:\n`;
            sortedPlayers.forEach(p => {
                const st = p.stats || emptyStats();
                const totalWins = (st.bigGold||0) + (st.smallGold||0) + (st.gold9||0) + (st.normal||0);
                
                text += `ğŸ‘¤ ${p.name}\n`;
                text += `   èƒœå±€: ${totalWins} | çŠ¯è§„: ${st.fouls||0}\n`;
                const specials = [];
                if(st.bigGold > 0) specials.push(`å¤§é‡‘x${st.bigGold}`);
                if(st.smallGold > 0) specials.push(`å°é‡‘x${st.smallGold}`);
                if(st.gold9 > 0) specials.push(`é»„é‡‘9x${st.gold9}`);
                if(st.blackGold > 0) specials.push(`é»‘é‡‘x${st.blackGold}`);
                
                if(specials.length > 0) {
                    text += `   ${specials.join(' ')}\n`;
                }
                text += `\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"));
        };
    </script>
</body>
</html>
